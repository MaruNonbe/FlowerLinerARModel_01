<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR Train Final Layout</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; background: transparent; font-family: sans-serif;
      user-select: none; -webkit-touch-callout: none;
    }
    a-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

    /* --- UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ --- */
    
    /* ç”»é¢ä¸Šéƒ¨ã®è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
    #ui-top {
      position: fixed; top: 10px; left: 0; width: 100%;
      display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
      pointer-events: none; /* éš™é–“ã¯ã‚¿ãƒƒãƒé€é */
      z-index: 9999;
    }

    /* ç”»é¢ä¸‹éƒ¨ã®æ“ä½œã‚¨ãƒªã‚¢ */
    #ui-bottom {
      position: fixed; bottom: 20px; left: 0; width: 100%;
      display: flex; flex-direction: column; align-items: center; gap: 10px;
      pointer-events: none;
      z-index: 9999;
    }

    /* ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆåŠé€æ˜ã«ã—ã¦é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
    .btn {
      background: rgba(255, 255, 255, 0.7); /* èƒŒæ™¯ã‚’åŠé€æ˜ã« */
      border: 1px solid rgba(0,0,0,0.3);
      border-radius: 8px;
      color: #333;
      font-weight: bold;
      cursor: pointer;
      pointer-events: auto; /* ãƒœã‚¿ãƒ³è‡ªä½“ã¯ã‚¿ãƒƒãƒæœ‰åŠ¹ */
      backdrop-filter: blur(4px); /* ã™ã‚Šã‚¬ãƒ©ã‚¹åŠ¹æœ */
      display: flex; justify-content: center; align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn:active { background: rgba(255, 255, 255, 0.9); transform: translateY(2px); }

    /* ä¸Šéƒ¨ç”¨ å°ã•ã‚ãƒœã‚¿ãƒ³ */
    .btn-sm {
      height: 40px; min-width: 44px; padding: 0 8px;
      font-size: 12px; flex-direction: column; gap: 0; line-height: 1.1;
    }
    .btn-sm span { font-size: 16px; }

    /* 3x3 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ */
    .pad-grid {
      display: grid;
      grid-template-columns: repeat(3, 60px); /* å°‘ã—å°ã•ãã—ã¦è¦–ç•Œç¢ºä¿ */
      grid-template-rows: repeat(3, 60px);
      gap: 6px;
      background: rgba(255, 255, 255, 0.2); /* ãƒ‘ãƒƒãƒ‰èƒŒæ™¯ã¯è–„ã */
      padding: 8px; border-radius: 16px;
      pointer-events: auto;
    }
    .pad-btn {
      font-size: 24px; width: 100%; height: 100%;
    }

    /* STOPãƒœã‚¿ãƒ³ */
    .btn-stop { background: rgba(255, 200, 200, 0.8); color: #c00; font-size: 14px; }

  </style>
</head>
<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="precision: mediump; antialias: true; alpha: true; logarithmicDepthBuffer: true;"
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
>
  <a-marker-camera preset="hiro">
    <a-entity id="train"
              gltf-model="models/AR-Train_Nagai.glb">
              </a-entity>
  </a-marker-camera>
</a-scene>

<div id="ui-top">
  <div class="btn btn-sm" id="btn-face"><span>ğŸ™‚</span>é¡”</div>
  <div class="btn btn-sm" id="btn-up"><span>â¬†</span>é«˜</div>
  <div class="btn btn-sm" id="btn-down"><span>â¬‡</span>ä½</div>
  <div class="btn btn-sm" id="btn-zoom-in"><span>ğŸ”</span>+</div>
  <div class="btn btn-sm" id="btn-zoom-out"><span>ğŸ”</span>-</div>
  <div style="width:10px;"></div> <div class="btn btn-sm" id="btn-capture"><span>ğŸ“·</span>æ’®</div>
  <div class="btn btn-sm" id="btn-record"><span>ğŸ¥</span>éŒ²</div>
</div>

<div id="ui-bottom">
  <div class="pad-grid">
    <div class="btn pad-btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn pad-btn" id="btn-fwd">â†‘</div>
    <div class="btn pad-btn" id="btn-curve-right-fwd">â†—</div>

    <div class="btn pad-btn" id="btn-turn-left">â†º</div>
    <div class="btn pad-btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn pad-btn" id="btn-turn-right">â†»</div>

    <div class="btn pad-btn" id="btn-curve-left-back">â†™</div>
    <div class="btn pad-btn" id="btn-back">â†“</div>
    <div class="btn pad-btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
const train = document.querySelector('#train');

// åˆæœŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
let speed = 0.05;
let turnSpeedInPlace = 2.0;
let turnSpeedCurve = 1.0;
let state = { moving: 0, turning: 0 };

/* ========== åˆæœŸä½ç½®è¨­å®šï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå¯¾å¿œï¼‰ ========== */
// ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿æ™‚ã€ã¾ãŸã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚ã«åˆæœŸä½ç½®ã‚’ã‚»ãƒƒãƒˆ
// AR.jsã®ãƒãƒ¼ã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€åŸç‚¹(0,0,0)ãŒã‚«ãƒ¡ãƒ©ä½ç½®ã§ã™ã€‚
// ãã®ãŸã‚ã€Zã‚’ãƒã‚¤ãƒŠã‚¹ã«ã™ã‚‹ã¨ã€Œã‚«ãƒ¡ãƒ©ã®å‰æ–¹ã€ã«ãªã‚Šã¾ã™ã€‚
function initPosition() {
  const mesh = train.object3D;
  if (mesh) {
    // X=0(ä¸­å¤®), Y=-0.5(å°‘ã—ä¸‹ã’ã‚‹=è»Šä½“ãŒä¸­å¿ƒã«æ¥ã‚‹), Z=-2.0(2må¥¥)
    mesh.position.set(0, -0.5, -2.0);
    mesh.scale.set(0.5, 0.5, 0.5); // ã‚¹ã‚±ãƒ¼ãƒ«åˆæœŸå€¤
    
    // å¿…è¦ã§ã‚ã‚Œã°å›è»¢ã‚‚ãƒªã‚»ãƒƒãƒˆ(0,0,0)
    mesh.rotation.set(0, 0, 0);
  }
}
// ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚ã«ã‚‚é©ç”¨
train.addEventListener('model-loaded', initPosition);
// å³æ™‚å®Ÿè¡Œï¼ˆæ—¢ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ãŸã‚ï¼‰
initPosition();


/* ========== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ========== */
function loop() {
  requestAnimationFrame(loop);
  if (!train.object3D) return;
  const mesh = train.object3D;

  // å›è»¢
  if (state.turning !== 0) {
    let rotationAmount = 0;
    if (state.moving !== 0) {
      rotationAmount = THREE.MathUtils.degToRad(turnSpeedCurve) * state.turning;
      if (state.moving === -1) rotationAmount *= -1; 
    } else {
      rotationAmount = THREE.MathUtils.degToRad(turnSpeedInPlace) * state.turning;
    }
    mesh.rotation.y += rotationAmount;
  }

  // ç§»å‹•
  if (state.moving !== 0) {
    const forward = new THREE.Vector3(0, 0, -1);
    forward.applyQuaternion(mesh.quaternion);
    forward.normalize();
    mesh.position.addScaledVector(forward, state.moving * speed);
  }
}
loop();

/* ========== ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ========== */
function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  if(!btn) return;
  const start = (e) => { if(e.cancelable) e.preventDefault(); state.moving = moveVal; state.turning = turnVal; };
  const end = (e) => { if(e.cancelable) e.preventDefault(); state.moving = 0; state.turning = 0; };

  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('mouseup', end);
  btn.addEventListener('mouseleave', end);
}

setAction('btn-fwd', 1, 0);
setAction('btn-back', -1, 0);
setAction('btn-turn-left', 0, 1);
setAction('btn-turn-right', 0, -1);
setAction('btn-curve-left-fwd', 1, 1);
setAction('btn-curve-right-fwd', 1, -1);
setAction('btn-curve-left-back', -1, 1);
setAction('btn-curve-right-back', -1, -1);

document.getElementById('btn-stop').addEventListener('click', (e)=>{ e.preventDefault(); state.moving=0; state.turning=0; });

/* ========== é¡”å†™çœŸ è¨­å®š ========== */
document.getElementById('btn-face').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const oldFace = train.object3D.getObjectByName('custom_face');
    if(oldFace) train.object3D.remove(oldFace);

    const url = URL.createObjectURL(file);
    new THREE.TextureLoader().load(url, (tex) => {
      tex.encoding = THREE.sRGBEncoding; tex.flipY = true;
      const geo = new THREE.PlaneGeometry(0.7, 0.7);
      const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide, transparent: true });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.name = 'custom_face';
      // å‰å›è¨­å®šã—ãŸã€Œé‹è»¢å¸­ã€ã®ä½ç½®
      mesh.position.set(0, 1.75, -0.5); 
      train.object3D.add(mesh);
    });
  };
  input.click();
};

/* ========== ãã®ä»–æ©Ÿèƒ½ ========== */
// é«˜ã•
document.getElementById('btn-up').onclick = () => train.object3D.position.y += 0.1;
document.getElementById('btn-down').onclick = () => train.object3D.position.y -= 0.1;
// ã‚ºãƒ¼ãƒ 
let curScale = 0.5;
document.getElementById('btn-zoom-in').onclick = () => { curScale+=0.1; train.object3D.scale.set(curScale,curScale,curScale); };
document.getElementById('btn-zoom-out').onclick = () => { curScale=Math.max(0.1, curScale-0.1); train.object3D.scale.set(curScale,curScale,curScale); };

// ã‚­ãƒ£ãƒ—ãƒãƒ£
document.getElementById('btn-capture').onclick = () => {
  const cvs = document.querySelector('canvas');
  cvs.toBlob(b=>{const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='ar.png'; a.click();});
};
// éŒ²ç”»
let recording = false, recorder, chunks=[];
document.getElementById('btn-record').onclick = () => {
  const cvs = document.querySelector('canvas');
  if(!recording){
    const st = cvs.captureStream();
    recorder = new MediaRecorder(st);
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const b = new Blob(chunks, {type:'video/webm'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='movie.webm'; a.click();
      chunks=[];
    };
    recorder.start(); recording=true; alert('éŒ²ç”»é–‹å§‹');
  } else {
    recorder.stop(); recording=false; alert('éŒ²ç”»çµ‚äº†');
  }
};

window.addEventListener('resize', () => {
  const s = document.querySelector('a-scene');
  if(s.camera) { s.camera.aspect = window.innerWidth/window.innerHeight; s.camera.updateProjectionMatrix(); }
});
</script>
</body>
</html>