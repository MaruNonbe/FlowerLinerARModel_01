<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR Train WebAR</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background-color: transparent;
      font-family: sans-serif;
    }

    a-scene {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: 1;
    }

    /* çŠ¶æ…‹è¡¨ç¤º */
    #status {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      padding: 6px;
      font-size: 14px;
      text-align: center;
      color: #0f0;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 4px;
      z-index: 9999;
      pointer-events: none;
    }

    /* ========== UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========== */
    #ui-container {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      height: auto;
      z-index: 9999;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    /* 3x3 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒƒãƒ‰ */
    .d-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      background: rgba(255, 255, 255, 0.2);
      padding: 10px;
      border-radius: 50%;
      pointer-events: auto;
    }

    .pad-btn {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #333;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      box-shadow: 0 4px 0 #666;
    }
    .pad-btn:active {
      background: #ccc;
      transform: translateY(4px);
      box-shadow: none;
    }
    /* çœŸã‚“ä¸­ã®åœæ­¢ãƒœã‚¿ãƒ³ */
    .pad-btn.stop {
      background: #ffcccc;
      font-size: 14px;
      font-weight: bold;
    }

    /* ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆæ©Ÿèƒ½ãƒœã‚¿ãƒ³ï¼‰ */
    .sub-menu {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      pointer-events: auto;
      margin-bottom: 10px;
    }
    .func-btn {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #555;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* é¡”èª¿æ•´ãƒ‘ãƒãƒ«ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ */
    #face-panel {
      display: none; /* JSã§åˆ‡ã‚Šæ›¿ãˆ */
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
      background: rgba(0,0,0,0.5);
      padding: 5px;
      border-radius: 8px;
      margin-bottom: 5px;
      pointer-events: auto;
    }
  </style>
</head>
<body>

<div id="status">ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­... ãƒãƒ¼ã‚«ãƒ¼ã‚’ç”¨æ„ã—ã¦ãã ã•ã„</div>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="precision: mediump; antialias: true; alpha: true;"
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
>
  <a-marker-camera preset="hiro">
    <a-entity id="train"
              gltf-model="models/AR-Train_Nagai.glb"
              position="0 0 -1"
              rotation="0 0 0"
              scale="0.5 0.5 0.5">
    </a-entity>
  </a-marker-camera>
</a-scene>

<div id="ui-container">
  
  <div id="face-panel">
    <div class="func-btn" id="btn-face-rotate-y">Yå›è»¢</div>
    <div class="func-btn" id="btn-face-rotate-x">Xå›è»¢</div>
    <div class="func-btn" id="btn-face-x-plus">X+</div>
    <div class="func-btn" id="btn-face-x-minus">X-</div>
    <div class="func-btn" id="btn-face-y-plus">Y+</div>
    <div class="func-btn" id="btn-face-y-minus">Y-</div>
    <div class="func-btn" id="btn-close-face" style="background:#ffcccc;">é–‰ã˜ã‚‹</div>
  </div>

  <div class="sub-menu">
    <div class="func-btn" id="btn-face">ğŸ˜Š é¡”å†™çœŸ</div>
    <div class="func-btn" id="btn-up">â¬† é«˜ã•</div>
    <div class="func-btn" id="btn-down">â¬‡ é«˜ã•</div>
    <div class="func-btn" id="btn-zoom-in">ğŸ”+</div>
    <div class="func-btn" id="btn-zoom-out">ğŸ”-</div>
    <div class="func-btn" id="btn-capture">ğŸ“¸</div>
    <div class="func-btn" id="btn-record">ğŸ¥</div>
  </div>

  <div class="d-pad">
    <div class="pad-btn" data-move="fwd-left">â†–</div>
    <div class="pad-btn" data-move="fwd">â†‘</div>
    <div class="pad-btn" data-move="fwd-right">â†—</div>
    
    <div class="pad-btn" data-move="spin-left">â†º</div>
    <div class="pad-btn stop" data-move="stop">STOP</div>
    <div class="pad-btn" data-move="spin-right">â†»</div>
    
    <div class="pad-btn" data-move="back-left">â†™</div>
    <div class="pad-btn" data-move="back">â†“</div>
    <div class="pad-btn" data-move="back-right">â†˜</div>
  </div>
</div>

<script>
/* ========== åˆæœŸè¨­å®š ========== */
const statusEl    = document.getElementById('status');
const train       = document.querySelector('#train');
let   facePlate   = null;
let   forwardAxis = 'z';
const FORWARD_SIGN = 1;

// â˜…èµ°è¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
const MOVE_SPEED   = 0.04; // é€Ÿåº¦
const TURN_SPEED   = 2.0;  // ãã®å ´å›è»¢é€Ÿåº¦
const CURVE_RADIUS = 0.6;  // ã‚«ãƒ¼ãƒ–åŠå¾„ (å°ã•ã„ã»ã©æ€¥ã‚«ãƒ¼ãƒ–)

let activeAction = null; // ç¾åœ¨æŠ¼ã•ã‚Œã¦ã„ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

let zoomLevel = 0.5;
let recording = false, recorder, chunks = [];
let faceRotationY = 0;
let faceRotationX = 0;

/* ========== ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ ========== */
train.addEventListener('model-loaded', () => {
  const root = train.getObject3D('mesh');
  if (!root) return;

  facePlate = root.getObjectByName('a_Plate') || root.getObjectByProperty('name', 'a_Plate');

  // å‰æ–¹æ–¹å‘ã®è‡ªå‹•åˆ¤å®š
  const box = new THREE.Box3().setFromObject(root);
  const size = new THREE.Vector3();
  box.getSize(size);
  forwardAxis = (size.x > size.z) ? 'x' : 'z';

  // åˆæœŸä½ç½®
  const obj = train.object3D;
  obj.position.set(0, 0, -2);
  obj.rotation.set(0, 0, 0);

  statusEl.textContent = 'Hiroãƒãƒ¼ã‚«ãƒ¼ã‚’æ˜ ã—ã¦ãã ã•ã„';
});

/* ========== é€²è¡Œæ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«è¨ˆç®— ========== */
function getForwardWorld(obj) {
  const local = (forwardAxis === 'x')
    ? new THREE.Vector3(FORWARD_SIGN, 0, 0)
    : new THREE.Vector3(0, 0, FORWARD_SIGN);
  return local.applyQuaternion(obj.quaternion).normalize();
}

/* ========== ç§»å‹•ãƒ«ãƒ¼ãƒ—ï¼ˆæ¯ãƒ•ãƒ¬ãƒ¼ãƒ å®Ÿè¡Œï¼‰ ========== */
function gameLoop() {
  if (activeAction) {
    moveTrain(activeAction);
    requestAnimationFrame(gameLoop);
  }
}

/* ========== ç§»å‹•ãƒ­ã‚¸ãƒƒã‚¯ ========== */
function moveTrain(action) {
  const obj = train.object3D;
  const pos = obj.position;

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦é€Ÿåº¦ã¨å›è»¢æ–¹å‘ã‚’å®šç¾©
  // speed: å‰é€²(+1) / å¾Œé€²(-1)
  // turn: å·¦å›è»¢(+1) / å³å›è»¢(-1)
  let speed = 0;
  let turn  = 0;
  let isSpin = false;

  switch (action) {
    case 'fwd':       speed = 1;  turn = 0;  break;
    case 'back':      speed = -1; turn = 0;  break;
    
    // ã‚«ãƒ¼ãƒ–: å‰é€²/å¾Œé€² ï¼‹ å›è»¢
    case 'fwd-left':  speed = 1;  turn = 1;  break; // å·¦ã¸æ›²ãŒã‚‹
    case 'fwd-right': speed = 1;  turn = -1; break; // å³ã¸æ›²ãŒã‚‹
    
    case 'back-left': speed = -1; turn = 1;  break; // ãƒãƒ³ãƒ‰ãƒ«å·¦ã§ãƒãƒƒã‚¯ï¼ˆå·¦å¾Œã‚ã¸ï¼‰
    case 'back-right':speed = -1; turn = -1; break; // ãƒãƒ³ãƒ‰ãƒ«å³ã§ãƒãƒƒã‚¯ï¼ˆå³å¾Œã‚ã¸ï¼‰
    
    // ãã®å ´å›è»¢
    case 'spin-left': speed = 0;  turn = 1; isSpin = true; break;
    case 'spin-right':speed = 0;  turn = -1; isSpin = true; break;
  }

  // è¨ˆç®—å®Ÿè¡Œ
  if (isSpin) {
    // ãã®å ´å›è»¢
    obj.rotation.y += turn * (TURN_SPEED * Math.PI / 180);
  } else if (speed !== 0) {
    if (turn !== 0) {
      // ã‚«ãƒ¼ãƒ–ç§»å‹• (ç§»å‹•ã—ãªãŒã‚‰å›è»¢)
      // Ï‰(è§’é€Ÿåº¦) = v / r
      // å¾Œé€²æ™‚ã‚‚ãƒãƒ³ãƒ‰ãƒ«ã®å‘ãé€šã‚Šã«å›è»¢ã•ã›ã‚‹
      const omega = (turn * Math.abs(speed * MOVE_SPEED)) / CURVE_RADIUS;
      obj.rotation.y += omega;
    }
    // å‰é€²ãƒ»å¾Œé€²
    pos.addScaledVector(getForwardWorld(obj), speed * MOVE_SPEED);
  }
}

/* ========== ãƒœã‚¿ãƒ³æ“ä½œã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ========== */
const padButtons = document.querySelectorAll('.pad-btn');

padButtons.forEach(btn => {
  const action = btn.dataset.move;

  // ã‚¿ãƒƒãƒé–‹å§‹ / ãƒã‚¦ã‚¹æŠ¼ã—ä¸‹ã’
  const startMove = (e) => {
    if (e.cancelable) e.preventDefault();
    if (action === 'stop') return; // STOPãƒœã‚¿ãƒ³ã¯è£…é£¾ï¼ˆã‚ã‚‹ã„ã¯ç·Šæ€¥åœæ­¢ç”¨ï¼‰
    
    if (!activeAction) {
      activeAction = action;
      gameLoop(); // ãƒ«ãƒ¼ãƒ—é–‹å§‹
    } else {
      activeAction = action; // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
    }
  };

  // ã‚¿ãƒƒãƒçµ‚äº† / ãƒã‚¦ã‚¹é›¢ã—
  const stopMove = (e) => {
    if (e.cancelable) e.preventDefault();
    activeAction = null; // ãƒ«ãƒ¼ãƒ—åœæ­¢
  };

  btn.addEventListener('touchstart', startMove, { passive: false });
  btn.addEventListener('touchend', stopMove);
  btn.addEventListener('mousedown', startMove);
  btn.addEventListener('mouseup', stopMove);
  btn.addEventListener('mouseleave', stopMove);
});


/* ========== ãã®ä»–æ©Ÿèƒ½ãƒœã‚¿ãƒ³ ========== */
document.getElementById('btn-up').onclick   = () => { train.object3D.position.y += 0.1; };
document.getElementById('btn-down').onclick = () => { train.object3D.position.y -= 0.1; };

// ã‚ºãƒ¼ãƒ 
document.getElementById('btn-zoom-in').onclick = () => {
  zoomLevel += 0.1;
  train.object3D.scale.set(zoomLevel, zoomLevel, zoomLevel);
};
document.getElementById('btn-zoom-out').onclick = () => {
  zoomLevel = Math.max(0.1, zoomLevel - 0.1);
  train.object3D.scale.set(zoomLevel, zoomLevel, zoomLevel);
};

// é¡”å†™çœŸãƒ‘ãƒãƒ«åˆ¶å¾¡
const facePanel = document.getElementById('face-panel');
document.getElementById('btn-face').onclick = () => {
  // ã¾ãšå†™çœŸã‚’é¸æŠ
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    applyFaceTexture(url);
    // ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
    facePanel.style.display = 'flex';
  };
  input.click();
};
document.getElementById('btn-close-face').onclick = () => {
  facePanel.style.display = 'none';
};

function applyFaceTexture(url) {
  const apply = () => {
    new THREE.TextureLoader().load(url, tex => {
      tex.flipY = false;
      tex.encoding = THREE.sRGBEncoding;
      if (facePlate) {
        facePlate.material.map = tex;
        facePlate.material.needsUpdate = true;
      } else {
        const geo = new THREE.PlaneGeometry(1, 1);
        const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(0.5, 2.8, -0.3);
        train.object3D.add(mesh);
        facePlate = mesh;
      }
    });
  };
  if (train.getObject3D('mesh')) apply();
  else train.addEventListener('model-loaded', apply, { once: true });
}

// é¡”èª¿æ•´ãƒœã‚¿ãƒ³
document.getElementById('btn-face-rotate-y').onclick = () => { if (facePlate) facePlate.rotation.y += Math.PI/2; };
document.getElementById('btn-face-rotate-x').onclick = () => { if (facePlate) facePlate.rotation.x += Math.PI/2; };
document.getElementById('btn-face-x-plus').onclick = () => { if (facePlate) facePlate.position.x += 0.05; };
document.getElementById('btn-face-x-minus').onclick = () => { if (facePlate) facePlate.position.x -= 0.05; };
document.getElementById('btn-face-y-plus').onclick = () => { if (facePlate) facePlate.position.y += 0.05; };
document.getElementById('btn-face-y-minus').onclick = () => { if (facePlate) facePlate.position.y -= 0.05; };

// æ’®å½±
document.getElementById('btn-capture').onclick = () => {
  const canvas = document.querySelector('canvas');
  canvas.toBlob(blob => {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'ar-train.png';
    link.click();
  });
};

// éŒ²ç”»
document.getElementById('btn-record').onclick = () => {
  const canvas = document.querySelector('canvas');
  if (!recording) {
    const stream = canvas.captureStream(30);
    recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
    recorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ar-movie.webm';
      a.click();
      chunks = [];
    };
    recorder.start();
    recording = true;
    alert('éŒ²ç”»é–‹å§‹');
  } else {
    recorder.stop();
    recording = false;
    alert('éŒ²ç”»çµ‚äº†');
  }
};

/* ========== æ­ªã¿è£œæ­£ ========== */
window.addEventListener('resize', () => {
  const scene = document.querySelector('a-scene');
  if (scene.camera) {
    scene.camera.aspect = window.innerWidth / window.innerHeight;
    scene.camera.updateProjectionMatrix();
  }
});
</script>
</body>
</html>