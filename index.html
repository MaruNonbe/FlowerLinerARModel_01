<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR Train Final Design</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    /* ===== åŸºæœ¬è¨­å®š ===== */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent;
      font-family: sans-serif;
      user-select: none;
      -webkit-touch-callout: none;
    }

    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* ===== UIã‚³ãƒ³ãƒ†ãƒŠï¼ˆä¸‹éƒ¨ã«å›ºå®šãƒ»å®‰å…¨é ˜åŸŸã‚’è€ƒæ…®ï¼‰ ===== */
    #ui-container {
      position: fixed;
      left: 0;
      width: 100%;
      bottom: calc(10px + env(safe-area-inset-bottom, 0px));
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      pointer-events: none;  /* å­è¦ç´ ã ã‘ã‚¿ãƒƒãƒ—å¯èƒ½ã«ã™ã‚‹ */
      padding: 0 8px;
      box-sizing: border-box;
    }

    /* ===== ä¸Šæ®µãƒ»ä¸­æ®µã®ãƒœã‚¿ãƒ³ãƒãƒ¼ï¼ˆæ¨ªä¸¦ã³ï¼‰ ===== */
    .top-bar {
      display: flex;
      gap: 8px;
      pointer-events: auto;
      background: rgba(255, 255, 255, 0.5);
      padding: 8px 10px;
      border-radius: 12px;
      backdrop-filter: blur(6px);
      max-width: 520px;
      width: 100%;
      justify-content: center;
      box-sizing: border-box;
    }

    /* ===== 3x3 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆæœ€ä¸‹æ®µï¼‰ ===== */
    .pad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      background: rgba(255, 255, 255, 0.5);
      padding: 12px;
      border-radius: 18px;
      pointer-events: auto;
      backdrop-filter: blur(6px);
      max-width: 300px;
      width: 100%;
      box-sizing: border-box;
    }

    /* ===== ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« ===== */
    .btn {
      width: 56px;
      height: 56px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #999;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.25);
      color: #333;
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, background 0.05s ease-out;
      box-sizing: border-box;
      touch-action: manipulation;
    }

    .btn:active {
      transform: translateY(3px);
      box-shadow: none;
      background: #e9e9e9;
    }

    /* å°ã•ã‚ãƒœã‚¿ãƒ³ï¼ˆæ©Ÿèƒ½ãƒœã‚¿ãƒ³ç”¨ï¼‰ */
    .btn-small {
      width: 54px;
      height: 54px;
      font-size: 10px;
      font-weight: bold;
      flex-direction: column;
      gap: 0;
    }

    .btn-small span {
      font-size: 18px;
      margin-bottom: 2px;
    }

    /* ãƒ‘ãƒƒãƒ‰å†…ã®çŸ¢å°ãƒœã‚¿ãƒ³ */
    .pad-grid .btn {
      font-size: 24px;
      color: #556677;
      font-weight: bold;
    }

    /* STOPãƒœã‚¿ãƒ³ */
    .btn-stop {
      background: #ffcccc;
      color: #d00;
      font-size: 14px;
      font-weight: bold;
    }

    /* ç”»é¢ãŒå°ã•ã„ç«¯æœ«å‘ã‘ã®èª¿æ•´ */
    @media (max-width: 430px) {
      .btn {
        width: 52px;
        height: 52px;
      }
      .btn-small {
        width: 50px;
        height: 50px;
      }
      .pad-grid {
        max-width: 270px;
        gap: 8px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="precision: mediump; antialias: true; alpha: true;"
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
>
  <a-light type="ambient" color="#FFF" intensity="0.8"></a-light>
  <a-light type="directional" position="-1 2 1" intensity="0.5"></a-light>

  <a-marker-camera preset="hiro">
    <a-entity id="train"
              gltf-model="models/AR-Train_Nagai.glb"
              position="0 0 0"
              scale="0.5 0.5 0.5">
    </a-entity>
  </a-marker-camera>
</a-scene>

<div id="ui-container">

  <!-- ä¸Šæ®µï¼šé¡”ãƒ»é«˜ã•ãƒ»æ‹¡å¤§ç¸®å° -->
  <div class="top-bar">
    <div class="btn btn-small" id="btn-face"><span>ğŸ™‚</span>é¡”</div>
    <div class="btn btn-small" id="btn-up"><span>â¬†</span>é«˜</div>
    <div class="btn btn-small" id="btn-down"><span>â¬‡</span>ä½</div>
    <div class="btn btn-small" id="btn-zoom-in"><span>ğŸ”</span>ï¼‹</div>
    <div class="btn btn-small" id="btn-zoom-out"><span>ğŸ”</span>ï¼</div>
  </div>

  <!-- ä¸­æ®µï¼šæ’®å½±ãƒ»éŒ²ç”» -->
  <div class="top-bar">
    <div class="btn btn-small" id="btn-capture"><span>ğŸ“·</span>æ’®</div>
    <div class="btn btn-small" id="btn-record"><span>ğŸ¥</span>éŒ²</div>
  </div>

  <!-- ä¸‹æ®µï¼šç§»å‹•ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© -->
  <div class="pad-grid">
    <div class="btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn" id="btn-fwd">â†‘</div>
    <div class="btn" id="btn-curve-right-fwd">â†—</div>

    <div class="btn" id="btn-turn-left">â†º</div>
    <div class="btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn" id="btn-turn-right">â†»</div>

    <div class="btn" id="btn-curve-left-back">â†™</div>
    <div class="btn" id="btn-back">â†“</div>
    <div class="btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
/* ========== åˆæœŸè¨­å®š ========== */
const train = document.querySelector('#train');

// ç§»å‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
let speed = 0.05;
let turnSpeedInPlace = 2.0; // ãã®å ´å›è»¢
let turnSpeedCurve   = 1.0; // ã‚«ãƒ¼ãƒ–å›è»¢ï¼ˆå¤§å›ã‚Šï¼‰
let state = { moving: 0, turning: 0 };

/* ========== ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ ========== */
function loop() {
  requestAnimationFrame(loop);

  if (!train.object3D) return;
  const mesh = train.object3D;

  // å›è»¢
  if (state.turning !== 0) {
    let rotationAmount = 0;
    if (state.moving !== 0) {
      // ã‚«ãƒ¼ãƒ–èµ°è¡Œ
      rotationAmount = THREE.MathUtils.degToRad(turnSpeedCurve) * state.turning;
      if (state.moving === -1) rotationAmount *= -1; // å¾Œé€²æ™‚ã¯é€†ãƒãƒ³ãƒ‰ãƒ«
    } else {
      // ãã®å ´å›è»¢
      rotationAmount = THREE.MathUtils.degToRad(turnSpeedInPlace) * state.turning;
    }
    mesh.rotation.y += rotationAmount;
  }

  // ç§»å‹•ï¼ˆZãƒã‚¤ãƒŠã‚¹æ–¹å‘ï¼ãƒ¢ãƒ‡ãƒ«ã®æ­£é¢ã¸é€²ã‚€ï¼‰
  if (state.moving !== 0) {
    const forward = new THREE.Vector3(0, 0, -1);
    forward.applyQuaternion(mesh.quaternion);
    forward.normalize();
    mesh.position.addScaledVector(forward, state.moving * speed);
  }
}
loop();

/* ========== é¡”å†™çœŸè¨­å®šï¼ˆçµ¶å¯¾ã«è¦‹ãˆã‚‹ç‰ˆï¼‰ ========== */
document.getElementById('btn-face').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    // æ—¢å­˜ã®é¡”å†™çœŸã‚’å‰Šé™¤
    const oldFace = train.object3D.getObjectByName('custom_face');
    if (oldFace) train.object3D.remove(oldFace);

    const url = URL.createObjectURL(file);
    new THREE.TextureLoader().load(url, (tex) => {
      tex.encoding = THREE.sRGBEncoding;
      tex.flipY = true; // ä¸Šä¸‹ä¿®æ­£

      const geo = new THREE.PlaneGeometry(0.7, 0.7);
      const mat = new THREE.MeshBasicMaterial({
        map: tex,
        side: THREE.DoubleSide,
        transparent: true,
        depthTest: false,
        depthWrite: false
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.name = 'custom_face';
      mesh.renderOrder = 999; // å¸¸ã«æœ€å‰é¢

      // ä½ç½®è¨­å®šï¼ˆé‹è»¢å¸­ä»˜è¿‘ï¼šå¿…è¦ã«å¿œã˜ã¦å¾®èª¿æ•´ï¼‰
      mesh.position.set(0, 1.7, 2.5);

      train.object3D.add(mesh);
    });
  };
  input.click();
};

/* ========== ãƒœã‚¿ãƒ³æ“ä½œ ========== */
function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  if (!btn) return;

  const start = (e) => {
    if (e.cancelable) e.preventDefault();
    state.moving  = moveVal;
    state.turning = turnVal;
  };

  const end = (e) => {
    if (e.cancelable) e.preventDefault();
    state.moving  = 0;
    state.turning = 0;
  };

  btn.addEventListener('touchstart', start, { passive: false });
  btn.addEventListener('touchend', end,   { passive: false });
  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', end);
  btn.addEventListener('mouseleave', end);
}

setAction('btn-fwd', 1, 0);
setAction('btn-back', -1, 0);
setAction('btn-turn-left', 0, 1);
setAction('btn-turn-right', 0, -1);
setAction('btn-curve-left-fwd', 1, 1);
setAction('btn-curve-right-fwd', 1, -1);
setAction('btn-curve-left-back', -1, 1);
setAction('btn-curve-right-back', -1, -1);

document.getElementById('btn-stop').addEventListener('click', (e) => {
  e.preventDefault();
  state.moving  = 0;
  state.turning = 0;
});

/* ========== ãã®ä»–æ©Ÿèƒ½ ========== */
document.getElementById('btn-up').onclick   = () => { train.object3D.position.y += 0.1; };
document.getElementById('btn-down').onclick = () => { train.object3D.position.y -= 0.1; };

let curScale = 0.5;
document.getElementById('btn-zoom-in').onclick = () => {
  curScale += 0.1;
  train.object3D.scale.set(curScale, curScale, curScale);
};
document.getElementById('btn-zoom-out').onclick = () => {
  curScale = Math.max(0.1, curScale - 0.1);
  train.object3D.scale.set(curScale, curScale, curScale);
};

// æ’®å½±
document.getElementById('btn-capture').onclick = () => {
  const cvs = document.querySelector('canvas');
  if (!cvs) return;
  cvs.toBlob(b => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = 'ar.png';
    a.click();
  });
};

// éŒ²ç”»ï¼ˆå¿…è¦ãªã‚‰å…ƒã®å®Ÿè£…ã‚’ã“ã“ã«è¿½åŠ ï¼‰

// ãƒªã‚µã‚¤ã‚ºè£œæ­£
window.addEventListener('resize', () => {
  const scene = document.querySelector('a-scene');
  if (scene && scene.camera) {
    scene.camera.aspect = window.innerWidth / window.innerHeight;
    scene.camera.updateProjectionMatrix();
  }
});
</script>
</body>
</html>
