<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR Train Control</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent;
      font-family: sans-serif;
    }

    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    #ui-container {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      pointer-events: none; /* UIä»¥å¤–ã®å ´æ‰€ã®ã‚¿ãƒƒãƒã‚’é€é */
    }

    /* ä¸Šéƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆé¡”å†™çœŸãªã©ï¼‰ */
    .top-bar {
      display: flex;
      gap: 8px;
      pointer-events: auto;
    }

    /* 3x3 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ */
    .pad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      background: rgba(255, 255, 255, 0.3);
      padding: 10px;
      border-radius: 15px;
      pointer-events: auto;
    }

    .btn {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #555;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 0 #888;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .btn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 #888;
      background: #eee;
    }

    /* STOPãƒœã‚¿ãƒ³ã¯èµ¤ã */
    .btn-stop {
      background: #ffcccc;
      color: #c00;
      font-size: 16px;
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³èª¿æ•´ */
    .icon-sm { font-size: 14px; }
  </style>
</head>
<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="precision: mediump; antialias: true; alpha: true;"
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
>
  <a-marker-camera preset="hiro">
    <a-entity id="train"
              gltf-model="models/AR-Train_Nagai.glb"
              position="0 0 0"
              scale="0.5 0.5 0.5">
    </a-entity>
  </a-marker-camera>
</a-scene>

<div id="ui-container">
  
  <div class="top-bar">
    <div class="btn icon-sm" id="btn-face">ğŸ™‚é¡”</div>
    <div class="btn icon-sm" id="btn-up">â¬†é«˜</div>
    <div class="btn icon-sm" id="btn-down">â¬‡ä½</div>
    <div class="btn icon-sm" id="btn-zoom-in">ğŸ”+</div>
    <div class="btn icon-sm" id="btn-zoom-out">ğŸ”-</div>
  </div>
  
  <div class="top-bar">
    <div class="btn icon-sm" id="btn-capture">ğŸ“·</div>
    <div class="btn icon-sm" id="btn-record">ğŸ¥</div>
  </div>

  <div class="pad-grid">
    <div class="btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn" id="btn-fwd">â†‘</div>
    <div class="btn" id="btn-curve-right-fwd">â†—</div>

    <div class="btn" id="btn-turn-left">â†º</div>
    <div class="btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn" id="btn-turn-right">â†»</div>

    <div class="btn" id="btn-curve-left-back">â†™</div>
    <div class="btn" id="btn-back">â†“</div>
    <div class="btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
/* ========== åˆæœŸè¨­å®š ========== */
const train = document.querySelector('#train');
let facePlate = null;

// ç§»å‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
let speed = 0.05;       // å‰é€²é€Ÿåº¦
let turnSpeed = 2.0;    // å›è»¢é€Ÿåº¦ï¼ˆåº¦/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
let curveRadius = 0.6;  // ã‚«ãƒ¼ãƒ–åŠå¾„

// çŠ¶æ…‹ãƒ•ãƒ©ã‚°
let state = {
  moving: 0,   // 0:åœæ­¢, 1:å‰é€², -1:å¾Œé€²
  turning: 0   // 0:ãªã—, 1:å·¦, -1:å³
};

/* ========== æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ ========== */
function loop() {
  requestAnimationFrame(loop);
  
  // ãƒ¢ãƒ‡ãƒ«ãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
  if (!train.object3D) return;

  const mesh = train.object3D;

  // 1. å›è»¢ã®è¨ˆç®—
  // ã‚«ãƒ¼ãƒ–èµ°è¡Œä¸­ï¼ˆç§»å‹•ï¼‹å›è»¢ï¼‰ã¾ãŸã¯ ãã®å ´å›è»¢ä¸­
  if (state.turning !== 0) {
    // ã‚‚ã—ç§»å‹•ä¸­ãªã‚‰ã€ã‚«ãƒ¼ãƒ–ã®åŠå¾„ã«å¿œã˜ãŸå›è»¢é‡ã‚’è¨ˆç®—ï¼ˆv = rÏ‰ => Ï‰ = v/rï¼‰
    let rotationAmount = 0;
    
    if (state.moving !== 0) {
      // ã‚«ãƒ¼ãƒ–èµ°è¡Œï¼šé€Ÿåº¦ã¨åŠå¾„ã‹ã‚‰è§’åº¦ã‚’ç®—å‡ºï¼ˆãƒ©ã‚¸ã‚¢ãƒ³ï¼‰
      // å³ã‚«ãƒ¼ãƒ–ã¯Yè»¸ãƒã‚¤ãƒŠã‚¹å›è»¢
      const omega = (speed / curveRadius); 
      rotationAmount = omega * state.turning; // turningãŒ 1(å·¦) ã‹ -1(å³)
      
      // å¾Œé€²æ™‚ã¯ãƒãƒ³ãƒ‰ãƒ«ã®åˆ‡ã‚Šæ–¹ãŒé€†ã«ãªã‚‹æ„Ÿè¦š
      if (state.moving === -1) rotationAmount *= -1;
      
    } else {
      // ãã®å ´å›è»¢ï¼ˆè¶…ä¿¡åœ°æ—‹å›ï¼‰ï¼šå›ºå®šã‚¹ãƒ”ãƒ¼ãƒ‰
      rotationAmount = THREE.MathUtils.degToRad(turnSpeed) * state.turning;
    }

    mesh.rotation.y += rotationAmount;
  }

  // 2. ç§»å‹•ã®è¨ˆç®—
  if (state.moving !== 0) {
    const direction = new THREE.Vector3(0, 0, 1); // ãƒ¢ãƒ‡ãƒ«ã®æ­£é¢ï¼ˆZè»¸ãƒ—ãƒ©ã‚¹ã¨ä»®å®šï¼‰
    // ç¾åœ¨ã®å›è»¢ã«åˆã‚ã›ã¦ãƒ™ã‚¯ãƒˆãƒ«ã‚’å›ã™
    direction.applyQuaternion(mesh.quaternion);
    
    // Zè»¸ã®å‘ããŒé€†ï¼ˆBlenderç­‰ã®åº§æ¨™ç³»ï¼‰ã®å ´åˆã¯ -1 ã‚’æ›ã‘ã‚‹èª¿æ•´ãŒå¿…è¦
    // ä»Šå›ã®ãƒ¢ãƒ‡ãƒ«ã¯Zãƒã‚¤ãƒŠã‚¹ãŒæ­£é¢ã®ã‚ˆã†ãªã®ã§èª¿æ•´
    // direction.negate(); 

    // ä½ç½®ã‚’æ›´æ–°
    // state.moving ãŒ 1ãªã‚‰å‰é€²ã€-1ãªã‚‰å¾Œé€²
    mesh.position.addScaledVector(direction, state.moving * speed);
  }
}
loop(); // ãƒ«ãƒ¼ãƒ—é–‹å§‹

/* ========== ãƒœã‚¿ãƒ³æ“ä½œã®ç´ä»˜ã‘ ========== */

// ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‹•ä½œã‚’è¨­å®šã™ã‚‹é–¢æ•°
function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  if(!btn) return;

  // ã‚¿ãƒƒãƒé–‹å§‹ / ãƒã‚¦ã‚¹æŠ¼ã—ä¸‹ã’
  const start = (e) => {
    e.preventDefault();
    state.moving = moveVal;
    state.turning = turnVal;
  };
  
  // æŒ‡ã‚’é›¢ã—ãŸã¨ãï¼ˆSTOPãƒœã‚¿ãƒ³ä»¥å¤–ã¯é›¢ã™ã¨æ­¢ã¾ã‚‹æŒ™å‹•ã«ã™ã‚‹å ´åˆï¼‰
  // â€»ä»Šå›ã¯ã€ŒæŠ¼ã—ã£ã±ãªã—ã§é€²ã‚€ã€æ–¹å¼ã«ã—ã¾ã™
  const end = (e) => {
    e.preventDefault();
    state.moving = 0;
    state.turning = 0;
  };

  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('mousedown', start);
  
  btn.addEventListener('touchend', end);
  btn.addEventListener('mouseup', end);
  btn.addEventListener('mouseleave', end);
}

// STOPãƒœã‚¿ãƒ³ï¼ˆå¼·åˆ¶åœæ­¢ï¼‰
const btnStop = document.getElementById('btn-stop');
btnStop.addEventListener('click', () => {
  state.moving = 0;
  state.turning = 0;
  // ä½ç½®ãƒªã‚»ãƒƒãƒˆã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–
  // train.object3D.position.set(0,0,0);
});

/* --- ãƒœã‚¿ãƒ³å‰²ã‚Šå½“ã¦ --- */

// 1. ç›´é€²ãƒ»å¾Œé€²
setAction('btn-fwd',  1, 0); // å‰é€²
setAction('btn-back', -1, 0); // å¾Œé€²

// 2. ãã®å ´å›è»¢ï¼ˆä¿¡åœ°æ—‹å›ï¼‰
setAction('btn-turn-left',  0, 1);  // å·¦å›è»¢
setAction('btn-turn-right', 0, -1); // å³å›è»¢

// 3. ã‚«ãƒ¼ãƒ–èµ°è¡Œï¼ˆæ–œã‚ãƒœã‚¿ãƒ³ï¼‰â˜…ã“ã“ãŒé‡è¦
// å·¦å‰ã‚«ãƒ¼ãƒ–ï¼š å‰é€²(1) ï¼‹ å·¦(1)
setAction('btn-curve-left-fwd', 1, 1);

// å³å‰ã‚«ãƒ¼ãƒ–ï¼š å‰é€²(1) ï¼‹ å³(-1)
setAction('btn-curve-right-fwd', 1, -1);

// å·¦å¾Œã‚«ãƒ¼ãƒ–ï¼š å¾Œé€²(-1) ï¼‹ å·¦(1) â€»å¾Œé€²æ™‚ã¯å·¦ãƒœã‚¿ãƒ³ã§ã€Œå·¦å¾Œã‚ã€ã«ãŠå°»ã‚’æŒ¯ã‚‹æŒ™å‹•
setAction('btn-curve-left-back', -1, 1);

// å³å¾Œã‚«ãƒ¼ãƒ–ï¼š å¾Œé€²(-1) ï¼‹ å³(-1)
setAction('btn-curve-right-back', -1, -1);


/* ========== ãã®ä»–ã®æ©Ÿèƒ½ï¼ˆé¡”å†™çœŸãªã©ï¼‰ ========== */
// é¡”å†™çœŸ
document.getElementById('btn-face').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    const tex = new THREE.TextureLoader().load(url);
    tex.encoding = THREE.sRGBEncoding; tex.flipY = false;
    
    // ç°¡æ˜“çš„ã«å¹³é¢ã‚’è¿½åŠ ã—ã¦é¡”ã«ã™ã‚‹
    const geo = new THREE.PlaneGeometry(0.8, 0.8);
    const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide, transparent:true });
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set(0, 2.0, 0.55); // ä½ç½®èª¿æ•´ï¼ˆãƒ¢ãƒ‡ãƒ«ã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
    train.object3D.add(mesh);
  };
  input.click();
};

// é«˜ã•èª¿æ•´
document.getElementById('btn-up').onclick = () => train.object3D.position.y += 0.1;
document.getElementById('btn-down').onclick = () => train.object3D.position.y -= 0.1;

// ã‚ºãƒ¼ãƒ 
let scale = 0.5;
document.getElementById('btn-zoom-in').onclick = () => { scale += 0.1; train.object3D.scale.set(scale,scale,scale); };
document.getElementById('btn-zoom-out').onclick = () => { scale = Math.max(0.1, scale - 0.1); train.object3D.scale.set(scale,scale,scale); };

// ç”»é¢ãƒªã‚µã‚¤ã‚ºè£œæ­£
window.addEventListener('resize', () => {
  const scene = document.querySelector('a-scene');
  if(scene.camera) {
    scene.camera.aspect = window.innerWidth / window.innerHeight;
    scene.camera.updateProjectionMatrix();
  }
});

</script>
</body>
</html>