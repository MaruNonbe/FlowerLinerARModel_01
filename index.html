<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AR Train WebAR (Marker)</title>

  <!-- ç”»é¢å…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ -->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
             user-scalable=no, viewport-fit=cover"
  />

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* A-Frame ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å¸¸ã«ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã« */
    a-scene {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
    }

    #ui {
      position: fixed;
      bottom: 10px;
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
      z-index: 999;
      pointer-events: auto;
    }

    .btn {
      min-width: 60px;
      text-align: center;
      font-size: 14px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
    }

    #message {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      z-index: 1000;
      pointer-events: none;
      display: none;
    }
  </style>
</head>
<body>

<div id="message"></div>

<!-- ãƒãƒ¼ã‚«ãƒ¼ARã‚·ãƒ¼ãƒ³ï¼ˆhiroï¼‰ -->
<a-scene
  embedded
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  vr-mode-ui="enabled: false">

  <!-- HIRO ãƒãƒ¼ã‚«ãƒ¼ã®ä¸Šã«åˆ—è»Šã‚’é…ç½® -->
  <a-marker preset="hiro">
    <a-entity
      id="train"
      gltf-model="models/AR-Train_Nagai.glb"
      position="0 0 0"
      rotation="0 0 0"
      scale="0.5 0.5 0.5">
    </a-entity>
  </a-marker>

  <!-- é€šå¸¸ã‚«ãƒ¡ãƒ© -->
  <a-entity camera></a-entity>
</a-scene>

<!-- ç”»é¢ä¸‹ã®UI -->
<div id="ui">
  <!-- ç§»å‹•ç³» -->
  <div class="btn" id="btn-forward">â†‘</div>
  <div class="btn" id="btn-backward">â†“</div>
  <div class="btn" id="btn-left">â†</div>
  <div class="btn" id="btn-right">â†’</div>
  <div class="btn" id="btn-curve-right">å³ã‚«ãƒ¼ãƒ–â†·</div>
  <div class="btn" id="btn-curve-left">â†¶å·¦ã‚«ãƒ¼ãƒ–</div>

  <div class="btn" id="btn-up">â¬†ï¸</div>
  <div class="btn" id="btn-down">â¬‡ï¸</div>

  <!-- é¡”å†™çœŸ -->
  <div class="btn" id="btn-face">é¡”å†™çœŸè¨­å®š</div>
  <div class="btn" id="btn-face-rotate-y">é¡”ğŸ”„Y</div>
  <div class="btn" id="btn-face-rotate-x">é¡”ğŸ”„X</div>
  <div class="btn" id="btn-face-x-plus">é¡”Xï¼‹</div>
  <div class="btn" id="btn-face-x-minus">é¡”Xï¼</div>
  <div class="btn" id="btn-face-y-plus">é¡”Yï¼‹</div>
  <div class="btn" id="btn-face-y-minus">é¡”Yï¼</div>

  <!-- ã‚ºãƒ¼ãƒ  -->
  <div class="btn" id="btn-zoom-in">ï¼‹</div>
  <div class="btn" id="btn-zoom-out">ï¼</div>

  <!-- æ’®å½±ãƒ»éŒ²ç”»ãƒ»å…±æœ‰ -->
  <div class="btn" id="btn-capture">ğŸ“¸</div>
  <div class="btn" id="btn-record">ğŸ¥</div>
  <div class="btn" id="btn-share">ğŸ“¤</div>
</div>

<script>
  // A-Frame ãŒæŒã£ã¦ã„ã‚‹ THREE ã‚’ä½¿ã†ï¼ˆåˆ¥é€” three.min.js ã¯èª­ã¿è¾¼ã¾ãªã„ï¼‰
  const THREE = window.THREE;

  const trainEl = document.querySelector('#train');
  const messageEl = document.getElementById('message');

  let facePlate = null;          // a_Plate ãƒ¡ãƒƒã‚·ãƒ¥ or è¿½åŠ Plane
  let forwardAxis = 'z';         // é•·æ‰‹æ–¹å‘ï¼ˆç°¡æ˜“æ¨å®šç”¨ï¼‰
  const FORWARD_SIGN = -1;       // -Z æ–¹å‘ã‚’å‰æ–¹ã¨ä»®å®š

  let zoomLevel = 0.5;
  let faceRotationY = 0;
  let faceRotationX = 0;

  const MOVE_SPEED = 0.4;        // m/s ç›¸å½“
  const ROTATE_SPEED_DEG = 60;   // deg/s
  const curveRadius = 2.0;       // ã‚«ãƒ¼ãƒ–åŠå¾„ï¼ˆè¦‹ãŸç›®ç”¨ï¼‰

  const moving = {
    forward: false,
    backward: false,
    left: false,
    right: false
  };

  function showMessage(text, ms = 2000) {
    messageEl.textContent = text;
    messageEl.style.display = 'block';
    if (ms > 0) {
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, ms);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trainEl.addEventListener('model-loaded', () => {
    const root = trainEl.getObject3D('mesh');
    if (!root) return;

    // a_Plate ã‚’æ¢ã™ï¼ˆé‹è»¢å¸­ã®é¡”å†™çœŸãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
    facePlate = root.getObjectByName('a_Plate') ||
                root.getObjectByProperty('name', 'a_Plate');

    // é•·æ‰‹æ–¹å‘ã‚’ã–ã£ãã‚Šæ¨å®šï¼ˆX ã¨ Z ã®é•·ã„æ–¹ï¼‰
    const box = new THREE.Box3().setFromObject(root);
    const size = new THREE.Vector3();
    box.getSize(size);
    forwardAxis = (size.x > size.z) ? 'x' : 'z';

    showMessage('ãƒãƒ¼ã‚«ãƒ¼ã«ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã‚‹ã¨åˆ—è»ŠãŒå‡ºã¾ã™');
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ç§»å‹•å‡¦ç†
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getForwardWorld(obj) {
    const local = (forwardAxis === 'x')
      ? new THREE.Vector3(FORWARD_SIGN, 0, 0)
      : new THREE.Vector3(0, 0, FORWARD_SIGN); // å‰æ–¹ã‚’ -Z ã¨ã¿ãªã™

    return local.applyQuaternion(obj.quaternion).normalize();
  }

  let prevTime = null;
  function updateMovement(timestamp) {
    if (!trainEl.object3D) {
      requestAnimationFrame(updateMovement);
      return;
    }

    if (prevTime === null) prevTime = timestamp;
    const dt = (timestamp - prevTime) / 1000;
    prevTime = timestamp;

    const obj = trainEl.object3D;

    const dir = moving.forward ? 1 : (moving.backward ? -1 : 0);
    const turn = moving.left ? 1 : (moving.right ? -1 : 0);

    if (dir !== 0 || turn !== 0) {
      const v = dir * MOVE_SPEED * dt;
      const forward = getForwardWorld(obj);

      if (dir !== 0 && turn !== 0) {
        // ã‚«ãƒ¼ãƒ–èµ°è¡Œï¼šå‰é€²ï¼‹æ—‹å›
        const omega = (turn * v) / curveRadius; // rad
        obj.rotation.y += omega;
        obj.position.addScaledVector(forward, v);
      } else if (dir !== 0) {
        // ç›´é€²
        obj.position.addScaledVector(forward, v);
      } else if (turn !== 0) {
        // ãã®å ´ã§æ—‹å›
        const rotRad = THREE.MathUtils.degToRad(ROTATE_SPEED_DEG * dt * turn);
        obj.rotation.y += rotRad;
      }
    }

    requestAnimationFrame(updateMovement);
  }
  requestAnimationFrame(updateMovement);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // UI ãƒœã‚¿ãƒ³è¨­å®š
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupMoveButton(btnId, key) {
    const btn = document.getElementById(btnId);
    const start = (e) => {
      moving[key] = true;
      e.preventDefault();
    };
    const end = (e) => {
      moving[key] = false;
      e && e.preventDefault();
    };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, { passive: false });
    btn.addEventListener('mouseup', end);
    btn.addEventListener('mouseleave', end);
    btn.addEventListener('touchend', end);
    btn.addEventListener('touchcancel', end);
  }

  // å‰é€²ãƒ»å¾Œé€€ãƒ»å·¦å³
  setupMoveButton('btn-forward',  'forward');
  setupMoveButton('btn-backward', 'backward');
  setupMoveButton('btn-left',     'left');
  setupMoveButton('btn-right',    'right');

  // å³ã‚«ãƒ¼ãƒ–ï¼šå‰é€²ï¼‹å³æ—‹å› / å·¦ã‚«ãƒ¼ãƒ–ï¼šå‰é€²ï¼‹å·¦æ—‹å›
  function setupCurveButton(btnId, turnKey) {
    const btn = document.getElementById(btnId);
    const start = (e) => {
      moving.forward = true;
      moving[turnKey] = true;
      e.preventDefault();
    };
    const end = (e) => {
      moving.forward = false;
      moving[turnKey] = false;
      e && e.preventDefault();
    };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, { passive: false });
    btn.addEventListener('mouseup', end);
    btn.addEventListener('mouseleave', end);
    btn.addEventListener('touchend', end);
    btn.addEventListener('touchcancel', end);
  }
  setupCurveButton('btn-curve-right', 'right');
  setupCurveButton('btn-curve-left',  'left');

  // ä¸Šä¸‹
  document.getElementById('btn-up').onclick = () => {
    trainEl.object3D.position.y += 0.05;
  };
  document.getElementById('btn-down').onclick = () => {
    trainEl.object3D.position.y -= 0.05;
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // é¡”å†™çœŸè¨­å®šï¼ˆé‹è»¢å¸­ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-face').onclick = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // iOS ã§ã‚«ãƒ¡ãƒ©ã‚‚é¸ã¹ã‚‹ã‚ˆã†ã«ãƒ’ãƒ³ãƒˆ

    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);

      const applyToPlate = () => {
        const texLoader = new THREE.TextureLoader();
        texLoader.load(url, (tex) => {
          tex.flipY = false;
          tex.encoding = THREE.sRGBEncoding;
          tex.needsUpdate = true;

          if (facePlate) {
            // æ—¢å­˜ã® a_Plate ã«è²¼ã‚‹
            if (!Array.isArray(facePlate.material)) {
              facePlate.material.map = tex;
              facePlate.material.transparent = true;
              facePlate.material.needsUpdate = true;
            }
            facePlate.rotation.y = faceRotationY;
            facePlate.rotation.x = faceRotationX;
          } else {
            // a_Plate ãŒç„¡ã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’è¿½åŠ 
            const geo = new THREE.PlaneGeometry(1.0, 1.0);
            const mat = new THREE.MeshBasicMaterial({
              map: tex,
              transparent: true,
              side: THREE.DoubleSide,
              depthTest: false,
              depthWrite: false
            });
            const mesh = new THREE.Mesh(geo, mat);
            // ã ã„ãŸã„é‹è»¢å¸­ä»˜è¿‘ã®ä½ç½®ï¼ˆå¿…è¦ãªã‚‰å¾Œã§ãƒœã‚¿ãƒ³ã§å¾®èª¿æ•´ï¼‰
            mesh.position.set(0.0, 1.4, 0.5);
            mesh.rotation.y = faceRotationY;
            mesh.rotation.x = faceRotationX;
            mesh.renderOrder = 10;
            trainEl.object3D.add(mesh);
            facePlate = mesh;
          }

          showMessage('é¡”å†™çœŸã‚’é‹è»¢å¸­ã«é…ç½®ã—ã¾ã—ãŸ', 1500);
        });
      };

      if (trainEl.getObject3D('mesh')) {
        applyToPlate();
      } else {
        trainEl.addEventListener('model-loaded', applyToPlate, { once: true });
      }
    };

    input.click();
  };

  document.getElementById('btn-face-rotate-y').onclick = () => {
    if (facePlate) {
      faceRotationY += Math.PI / 2;
      facePlate.rotation.y = faceRotationY;
    }
  };

  document.getElementById('btn-face-rotate-x').onclick = () => {
    if (facePlate) {
      faceRotationX += Math.PI / 2;
      facePlate.rotation.x = faceRotationX;
    }
  };

  document.getElementById('btn-face-x-plus').onclick = () => {
    if (facePlate) facePlate.position.x += 0.05;
  };
  document.getElementById('btn-face-x-minus').onclick = () => {
    if (facePlate) facePlate.position.x -= 0.05;
  };
  document.getElementById('btn-face-y-plus').onclick = () => {
    if (facePlate) facePlate.position.y += 0.05;
  };
  document.getElementById('btn-face-y-minus').onclick = () => {
    if (facePlate) facePlate.position.y -= 0.05;
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ã‚ºãƒ¼ãƒ ï¼ˆåˆ—è»Šå…¨ä½“ã®ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-zoom-in').onclick = () => {
    zoomLevel += 0.1;
    trainEl.object3D.scale.set(zoomLevel, zoomLevel, zoomLevel);
  };
  document.getElementById('btn-zoom-out').onclick = () => {
    zoomLevel = Math.max(0.1, zoomLevel - 0.1);
    trainEl.object3D.scale.set(zoomLevel, zoomLevel, zoomLevel);
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æ’®å½±ãƒ»éŒ²ç”»ãƒ»å…±æœ‰
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-capture').onclick = () => {
    const canvas = document.querySelector('canvas');
    if (!canvas) return;
    canvas.toBlob((blob) => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'snapshot.png';
      a.click();
    });
  };

  let recording = false;
  let recorder = null;
  let chunks = [];

  document.getElementById('btn-record').onclick = () => {
    const canvas = document.querySelector('canvas');
    if (!canvas) return;

    if (!recording) {
      const stream = canvas.captureStream();
      try {
        recorder = new MediaRecorder(stream);
      } catch (e) {
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŒ²ç”»ã«å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
        return;
      }

      recorder.ondataavailable = (e) => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'recording.webm';
        a.click();
        chunks = [];
      };

      recorder.start();
      recording = true;
      showMessage('éŒ²ç”»é–‹å§‹', 1000);
    } else {
      recorder.stop();
      recording = false;
      showMessage('éŒ²ç”»çµ‚äº†', 1000);
    }
  };

  document.getElementById('btn-share').onclick = () => {
    if (navigator.share) {
      navigator.share({
        title: 'AR Train',
        text: 'ARã§åˆ—è»Šã‚’é‹è»¢ã—ã¾ã—ãŸï¼',
        url: location.href
      }).catch(() => {});
    } else {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Webã‚·ã‚§ã‚¢APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
    }
  };
</script>

</body>
</html>
