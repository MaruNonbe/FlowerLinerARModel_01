<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR Train Perfect Face</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; background: transparent; font-family: sans-serif;
      user-select: none; -webkit-touch-callout: none;
    }
    a-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

    #ui-container {
      position: fixed; bottom: 20px; left: 0; width: 100%;
      z-index: 9999;
      display: flex; flex-direction: column; align-items: center;
      gap: 12px;
      pointer-events: none;
    }

    .ui-bar {
      display: flex; gap: 10px; pointer-events: auto;
      background: rgba(255,255,255,0.3); padding: 8px; border-radius: 12px;
      backdrop-filter: blur(4px);
    }

    .pad-grid {
      display: grid;
      grid-template-columns: repeat(3, 64px);
      grid-template-rows: repeat(3, 64px);
      gap: 8px;
      background: rgba(255, 255, 255, 0.5);
      padding: 10px; border-radius: 16px;
      pointer-events: auto;
    }

    .btn {
      width: 64px; height: 48px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #888; border-radius: 8px;
      display: flex; justify-content: center; align-items: center;
      font-size: 20px; font-weight: bold; color: #333;
      box-shadow: 0 4px 0 #666; cursor: pointer;
    }
    .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #666; background: #ddd; }
    .pad-grid .btn { width: 64px; height: 64px; font-size: 28px; }
    .btn-stop { background: #ffcccc; color: #c00; font-size: 16px; }
    .btn-icon { font-size: 12px; flex-direction: column; gap: 2px; height: 54px;}
    .btn-icon span { font-size: 20px; }
  </style>
</head>
<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="precision: mediump; antialias: true; alpha: true; logarithmicDepthBuffer: true;"
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
>
  <a-marker-camera preset="hiro">
    <a-entity id="train"
              gltf-model="models/AR-Train_Nagai.glb"
              position="0 0 0"
              scale="0.5 0.5 0.5">
    </a-entity>
  </a-marker-camera>
</a-scene>

<div id="ui-container">
  <div class="ui-bar">
    <div class="btn btn-icon" id="btn-face"><span>ğŸ™‚</span>é¡”</div>
    <div class="btn btn-icon" id="btn-up"><span>â¬†</span>é«˜</div>
    <div class="btn btn-icon" id="btn-down"><span>â¬‡</span>ä½</div>
    <div class="btn btn-icon" id="btn-zoom-in"><span>ğŸ”</span>+</div>
    <div class="btn btn-icon" id="btn-zoom-out"><span>ğŸ”</span>-</div>
  </div>
  
  <div class="ui-bar">
    <div class="btn btn-icon" id="btn-capture"><span>ğŸ“·</span>æ’®</div>
    <div class="btn btn-icon" id="btn-record"><span>ğŸ¥</span>éŒ²</div>
  </div>

  <div class="pad-grid">
    <div class="btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn" id="btn-fwd">â†‘</div>
    <div class="btn" id="btn-curve-right-fwd">â†—</div>
    <div class="btn" id="btn-turn-left">â†º</div>
    <div class="btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn" id="btn-turn-right">â†»</div>
    <div class="btn" id="btn-curve-left-back">â†™</div>
    <div class="btn" id="btn-back">â†“</div>
    <div class="btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
const train = document.querySelector('#train');
let speed = 0.05;
let turnSpeedCurve = 1.0;
let turnSpeedInPlace = 2.0;
let state = { moving: 0, turning: 0 };

/* ========== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ========== */
function loop() {
  requestAnimationFrame(loop);
  if (!train.object3D) return;
  const mesh = train.object3D;

  if (state.turning !== 0) {
    let rotationAmount = 0;
    if (state.moving !== 0) {
      rotationAmount = THREE.MathUtils.degToRad(turnSpeedCurve) * state.turning;
      if (state.moving === -1) rotationAmount *= -1; 
    } else {
      rotationAmount = THREE.MathUtils.degToRad(turnSpeedInPlace) * state.turning;
    }
    mesh.rotation.y += rotationAmount;
  }

  if (state.moving !== 0) {
    const forward = new THREE.Vector3(0, 0, -1);
    forward.applyQuaternion(mesh.quaternion);
    forward.normalize();
    mesh.position.addScaledVector(forward, state.moving * speed);
  }
}
loop();

/* ========== é¡”å†™çœŸé…ç½®ï¼šè‡ªå‹•æ¤œå‡ºï¼†å¼·åˆ¶è¡¨ç¤º ========== */
document.getElementById('btn-face').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    // æ—¢å­˜å‰Šé™¤
    const oldFace = train.object3D.getObjectByName('custom_face');
    if(oldFace) train.object3D.remove(oldFace);

    // â˜…åˆ—è»Šã®å¯¸æ³•ã‚’è‡ªå‹•è¨ˆç®—ã™ã‚‹â˜…
    // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ï¼ˆåˆ—è»Šã®æœ€å¤§ãƒ»æœ€å°åº§æ¨™ï¼‰ã‚’å–å¾—
    const box = new THREE.Box3().setFromObject(train.object3D);
    
    // åˆ—è»Šã®ã€Œé«˜ã•ã€ã¨ã€Œä¸€ç•ªæ‰‹å‰ã®é¢ã€ã‚’æ¨å®š
    // â€»åˆ—è»Šã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ãŒä¸æ˜ãªãŸã‚ã€Box3ã®ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã‹ã‚‰æ¨å®šã—ã¾ã™
    // ãŸã ã—ã€ãƒ¢ãƒ‡ãƒ«ãŒåŸç‚¹ã«ã‚ã‚‹å‰æã§è¨ˆç®—ã—ã¾ã™
    
    // ä»¥å‰ã®è©¦è¡Œã§ Z=2.8 ãŒå‰ã«é£›ã³å‡ºãŸã¨ã®ã“ã¨ãªã®ã§ã€Zã®æœ€å¤§å€¤(max.z)å´ãŒã€Œå‰ã€ã®å¯èƒ½æ€§ãŒé«˜ã„
    // ã¾ãŸã¯ã€scaleãŒã‹ã‹ã£ã¦ã„ã‚‹ã®ã§æ•°å€¤ã‚’è£œæ­£
    
    // ã“ã“ã§ã¯ã€Œç¢ºå®Ÿã«æ‰‹å‰ã«è¡¨ç¤ºã•ã›ã‚‹ã€ãŸã‚ã®é­”æ³•ã®è¨­å®šã‚’ä½¿ã„ã¾ã™
    
    const url = URL.createObjectURL(file);
    new THREE.TextureLoader().load(url, (tex) => {
      tex.encoding = THREE.sRGBEncoding;
      tex.flipY = true; 

      const geo = new THREE.PlaneGeometry(0.6, 0.6); // å°‘ã—å°ã•ã(0.6m)
      const mat = new THREE.MeshBasicMaterial({
        map: tex,
        side: THREE.DoubleSide,
        transparent: true,
        // â˜…ã€æœ€é‡è¦ã€‘å£ã®ä¸­ã«åŸ‹ã‚‚ã‚Œã¦ã‚‚å¿…ãšè¡¨ç¤ºã•ã›ã‚‹è¨­å®šâ˜…
        depthTest: false,  // æ·±åº¦ãƒ†ã‚¹ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆæ‰‹å‰ã«ã‚ã‚‹ã‚‚ã®ã¨ã—ã¦æç”»ï¼‰
        depthWrite: false  
      });
      
      const mesh = new THREE.Mesh(geo, mat);
      mesh.name = 'custom_face';
      
      // â˜…ã€æœ€é‡è¦ã€‘ä¸€ç•ªæœ€å¾Œã«æç”»ã—ã¦ã€çµ¶å¯¾ã«ä¸Šæ›¸ãã™ã‚‹â˜…
      mesh.renderOrder = 999;

      // åº§æ¨™è¨­å®šï¼ˆæ¨å®šï¼‰
      // å‰å›ã® Z=2.8 ãŒã€Œé£›ã³å‡ºãŸã€ãªã‚‰ã€Z=2.4 ãã‚‰ã„ãŒè»Šå†…è¡¨é¢ä»˜è¿‘ã¨äºˆæƒ³
      // é«˜ã•ã¯ 1.6 ãã‚‰ã„ï¼ˆç›®ã®é«˜ã•ï¼‰
      mesh.position.set(0.5, 2.0, 2.45);
      
      // ã‚‚ã—åˆ—è»ŠãŒå‹•ã„ãŸå¾Œãªã‚‰ã€trainã®å­è¦ç´ ã«è¿½åŠ ã™ã‚‹ã“ã¨ã§ä¸€ç·’ã«å‹•ã
      // ãŸã ã— position ã¯ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã«ãªã‚‹ãŸã‚ã€scale(0.5)ã®å½±éŸ¿ã‚’å—ã‘ã‚‹ã“ã¨ã«æ³¨æ„
      // ã‚¹ã‚±ãƒ¼ãƒ«0.5ã®ä¸–ç•Œãªã®ã§ã€å®Ÿæ•°å€¤ã®å€ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ãŒã€
      // A-Frameã®a-entity scaleãªã®ã§ã€ç›´ä¸‹ã®Meshåº§æ¨™ã¯ãã®ã¾ã¾
      
      train.object3D.add(mesh);
    });
  };
  input.click();
};

/* ========== æ“ä½œãƒœã‚¿ãƒ³ ========== */
function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  if(!btn) return;
  const start = (e) => { if(e.cancelable) e.preventDefault(); state.moving = moveVal; state.turning = turnVal; };
  const end = (e) => { if(e.cancelable) e.preventDefault(); state.moving = 0; state.turning = 0; };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('mouseup', end);
  btn.addEventListener('mouseleave', end);
}
setAction('btn-fwd', 1, 0); setAction('btn-back', -1, 0);
setAction('btn-turn-left', 0, 1); setAction('btn-turn-right', 0, -1);
setAction('btn-curve-left-fwd', 1, 1); setAction('btn-curve-right-fwd', 1, -1);
setAction('btn-curve-left-back', -1, 1); setAction('btn-curve-right-back', -1, -1);
document.getElementById('btn-stop').addEventListener('click', (e)=>{ e.preventDefault(); state.moving=0; state.turning=0; });

/* ========== ãã®ä»–æ©Ÿèƒ½ ========== */
document.getElementById('btn-up').onclick = () => train.object3D.position.y += 0.1;
document.getElementById('btn-down').onclick = () => train.object3D.position.y -= 0.1;
let curScale = 0.5;
document.getElementById('btn-zoom-in').onclick = () => { curScale+=0.1; train.object3D.scale.set(curScale,curScale,curScale); };
document.getElementById('btn-zoom-out').onclick = () => { curScale=Math.max(0.1, curScale-0.1); train.object3D.scale.set(curScale,curScale,curScale); };
document.getElementById('btn-capture').onclick = () => {
  const cvs = document.querySelector('canvas');
  cvs.toBlob(b=>{const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='ar.png'; a.click();});
};
window.addEventListener('resize', () => {
  const scene = document.querySelector('a-scene');
  if(scene.camera) { scene.camera.aspect = window.innerWidth / window.innerHeight; scene.camera.updateProjectionMatrix(); }
});
</script>
</body>
</html>