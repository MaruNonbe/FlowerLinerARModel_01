<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AR Train WebXR Floor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000;
    }

    #ar-start {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      z-index: 1000;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      cursor: pointer;
    }

    #ui {
      position: fixed;
      bottom: 10px;
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
      z-index: 999;
      pointer-events: auto;
    }

    .btn {
      min-width: 48px;
      text-align: center;
      font-size: 14px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
    }

    #message {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      z-index: 1000;
      pointer-events: none;
      display: none;
    }
  </style>
</head>
<body>

<button id="ar-start">ARé–‹å§‹ï¼ˆåºŠã«åˆ—è»Šã‚’ç½®ãï¼‰</button>
<div id="message"></div>

<div id="ui">
  <div class="btn" id="btn-forward">â†‘</div>
  <div class="btn" id="btn-backward">â†“</div>
  <div class="btn" id="btn-left">â†</div>
  <div class="btn" id="btn-right">â†’</div>
  <div class="btn" id="btn-up">â¬†ï¸</div>
  <div class="btn" id="btn-down">â¬‡ï¸</div>

  <div class="btn" id="btn-face">é¡”å†™çœŸè¨­å®š</div>
  <div class="btn" id="btn-face-rotate-y">ğŸ”„Y</div>
  <div class="btn" id="btn-face-rotate-x">ğŸ”„X</div>
  <div class="btn" id="btn-face-x-plus">é¡”Xï¼‹</div>
  <div class="btn" id="btn-face-x-minus">é¡”Xï¼</div>
  <div class="btn" id="btn-face-y-plus">é¡”Yï¼‹</div>
  <div class="btn" id="btn-face-y-minus">é¡”Yï¼</div>

  <div class="btn" id="btn-zoom-in">ï¼‹</div>
  <div class="btn" id="btn-zoom-out">ï¼</div>

  <div class="btn" id="btn-capture">ğŸ“¸</div>
  <div class="btn" id="btn-record">ğŸ¥</div>
  <div class="btn" id="btn-share">ğŸ“¤</div>
</div>

<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.module.js';
  import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.150.0/examples/jsm/loaders/GLTFLoader.js';

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // åŸºæœ¬ Three.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  renderer.xr.setReferenceSpaceType('local-floor');
  document.body.appendChild(renderer.domElement);

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // ç…§æ˜ï¼ˆç°¡æ˜“ï¼‰
  const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
  scene.add(light);

  // åˆ—è»Šãƒ¢ãƒ‡ãƒ«
  let train = null;
  let trainPlaced = false;
  let forwardAxis = 'z';
  const FORWARD_SIGN = 1;
  let facePlate = null;

  const loader = new GLTFLoader();
  loader.load(
    'models/AR-Train_Nagai.glb',
    (gltf) => {
      train = gltf.scene;
      train.visible = false;
      const initialScale = 0.5;
      train.scale.set(initialScale, initialScale, initialScale);
      scene.add(train);

      // a_Plate ã‚’æ¢ã—ã¦è¨˜éŒ²
      facePlate = train.getObjectByName('a_Plate');

      // é•·æ‰‹æ–¹å‘æ¨å®š
      const box = new THREE.Box3().setFromObject(train);
      const sz = new THREE.Vector3();
      box.getSize(sz);
      forwardAxis = (sz.x > sz.z) ? 'x' : 'z';

      showMessage('åˆ—è»Šãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ARé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    },
    undefined,
    (err) => {
      console.error(err);
      showMessage('åˆ—è»Šãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
  );

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // WebXR AR + Hit-test
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const arStartButton = document.getElementById('ar-start');
  const messageEl = document.getElementById('message');

  let hitTestSource = null;
  let hitTestSourceRequested = false;

  function showMessage(text, ms = 2000) {
    messageEl.textContent = text;
    messageEl.style.display = 'block';
    if (ms > 0) {
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, ms);
    }
  }

  async function startAR() {
    if (!navigator.xr) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ WebXR ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
      return;
    }
    try {
      const session = await navigator.xr.requestSession('immersive-ar', {
        requiredFeatures: ['hit-test', 'local-floor', 'dom-overlay'],
        domOverlay: { root: document.body }
      });

      session.addEventListener('end', () => {
        hitTestSourceRequested = false;
        hitTestSource = null;
        trainPlaced = false;
        if (train) {
          train.visible = false;
        }
        showMessage('ARã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚', 1500);
      });

      await renderer.xr.setSession(session);

      showMessage('åºŠã‚’æ¤œå‡ºä¸­â€¦ å°‘ã—ã‚«ãƒ¡ãƒ©ã‚’å‹•ã‹ã—ã¦ãã ã•ã„ã€‚');

    } catch (e) {
      console.error(e);
      alert('ARã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
    }
  }

  arStartButton.addEventListener('click', startAR);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // åˆ—è»Šç§»å‹•ï¼ˆå‰é€²ãƒ»å¾Œé€€ãƒ»å·¦å³ã‚«ãƒ¼ãƒ–ï¼‰
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const MOVE_SPEED = 0.5;        // m/s ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
  const ROTATE_SPEED_DEG = 60;   // deg/s
  const curveRadius = 2.0;       // ã‚«ãƒ¼ãƒ–åŠå¾„

  const moving = { forward: false, backward: false, left: false, right: false };

  function getForwardWorld(obj) {
    if (!obj) return new THREE.Vector3(0,0,-1);
    const local = (forwardAxis === 'x')
      ? new THREE.Vector3(FORWARD_SIGN, 0, 0)
      : new THREE.Vector3(0, 0, FORWARD_SIGN);
    return local.applyQuaternion(obj.quaternion).normalize();
  }

  function setupMoveButton(id, dirKey) {
    const btn = document.getElementById(id);
    const start = (e) => {
      moving[dirKey] = true;
      e.preventDefault();
    };
    const end = (e) => {
      moving[dirKey] = false;
      e && e.preventDefault();
    };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, { passive: false });
    btn.addEventListener('mouseup', end);
    btn.addEventListener('mouseleave', end);
    btn.addEventListener('touchend', end);
    btn.addEventListener('touchcancel', end);
  }

  setupMoveButton('btn-forward', 'forward');
  setupMoveButton('btn-backward', 'backward');
  setupMoveButton('btn-left', 'left');
  setupMoveButton('btn-right', 'right');

  // ä¸Šä¸‹ç§»å‹•ï¼ˆYï¼‰
  document.getElementById('btn-up').onclick = () => {
    if (train && trainPlaced) train.position.y += 0.1;
  };
  document.getElementById('btn-down').onclick = () => {
    if (train && trainPlaced) train.position.y -= 0.1;
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // é¡”å†™çœŸæ©Ÿèƒ½ï¼ˆã‚«ãƒ¡ãƒ© or å†™çœŸãƒ•ã‚©ãƒ«ãƒ€ï¼‰
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let faceRotationY = 0;
  let faceRotationX = 0;

  document.getElementById('btn-face').onclick = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    // iOS ã§ã‚«ãƒ¡ãƒ©ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ãƒ’ãƒ³ãƒˆ
    input.capture = 'environment';

    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);

      const applyToPlate = () => {
        const texLoader = new THREE.TextureLoader();
        texLoader.load(url, (tex) => {
          tex.flipY = false;
          tex.encoding = THREE.sRGBEncoding;
          tex.needsUpdate = true;

          if (facePlate) {
            // æ—¢å­˜ a_Plate ã«è²¼ã‚‹
            if (!Array.isArray(facePlate.material)) {
              facePlate.material.map = tex;
              facePlate.material.transparent = true;
              facePlate.material.needsUpdate = true;
            }
            facePlate.rotation.y = faceRotationY;
            facePlate.rotation.x = faceRotationX;
          } else if (train) {
            // a_Plate ãŒãªã„å ´åˆã¯Planeã‚’æ–°è¦è¿½åŠ 
            const geo = new THREE.PlaneGeometry(1.0, 1.0);
            const mat = new THREE.MeshBasicMaterial({
              map: tex,
              transparent: true,
              side: THREE.DoubleSide,
              depthTest: false,
              depthWrite: false
            });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(0.5, 2.8, -0.3);
            mesh.rotation.y = faceRotationY;
            mesh.rotation.x = faceRotationX;
            mesh.renderOrder = 10;
            train.add(mesh);
            facePlate = mesh;
          }

          showMessage('é¡”å†™çœŸã‚’é‹è»¢å¸­ã«é…ç½®ã—ã¾ã—ãŸã€‚', 1500);
        });
      };

      if (train) {
        applyToPlate();
      } else {
        loader.manager.onLoad = applyToPlate;
      }
    };
    input.click();
  };

  document.getElementById('btn-face-rotate-y').onclick = () => {
    if (facePlate) {
      faceRotationY += Math.PI / 2;
      facePlate.rotation.y = faceRotationY;
    }
  };

  document.getElementById('btn-face-rotate-x').onclick = () => {
    if (facePlate) {
      faceRotationX += Math.PI / 2;
      facePlate.rotation.x = faceRotationX;
    }
  };

  document.getElementById('btn-face-x-plus').onclick = () => {
    if (facePlate) facePlate.position.x += 0.05;
  };
  document.getElementById('btn-face-x-minus').onclick = () => {
    if (facePlate) facePlate.position.x -= 0.05;
  };
  document.getElementById('btn-face-y-plus').onclick = () => {
    if (facePlate) facePlate.position.y += 0.05;
  };
  document.getElementById('btn-face-y-minus').onclick = () => {
    if (facePlate) facePlate.position.y -= 0.05;
  };

  // ã‚ºãƒ¼ãƒ ï¼ˆåˆ—è»Šã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
  let zoomLevel = 0.5;
  document.getElementById('btn-zoom-in').onclick = () => {
    if (!train) return;
    zoomLevel += 0.1;
    train.scale.set(zoomLevel, zoomLevel, zoomLevel);
  };
  document.getElementById('btn-zoom-out').onclick = () => {
    if (!train) return;
    zoomLevel = Math.max(0.1, zoomLevel - 0.1);
    train.scale.set(zoomLevel, zoomLevel, zoomLevel);
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // å†™çœŸæ’®å½±ãƒ»éŒ²ç”»ãƒ»SNSå…±æœ‰
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-capture').onclick = () => {
    const canvas = renderer.domElement;
    canvas.toBlob((blob) => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'snapshot.png';
      a.click();
    });
  };

  let recording = false;
  let recorder = null;
  let chunks = [];

  document.getElementById('btn-record').onclick = () => {
    const canvas = renderer.domElement;
    if (!recording) {
      const stream = canvas.captureStream();
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = (e) => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'recording.webm';
        a.click();
        chunks = [];
      };
      recorder.start();
      recording = true;
      showMessage('éŒ²ç”»é–‹å§‹', 1000);
    } else {
      recorder.stop();
      recording = false;
      showMessage('éŒ²ç”»çµ‚äº†', 1000);
    }
  };

  document.getElementById('btn-share').onclick = () => {
    if (navigator.share) {
      navigator.share({
        title: 'AR Train',
        text: 'ARã§é‹è»¢å¸­ã‹ã‚‰åˆ—è»Šã‚’é‹è»¢ã—ã¦ã¿ã¾ã—ãŸï¼',
        url: location.href
      }).catch((e) => {
        console.log(e);
      });
    } else {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Webã‚·ã‚§ã‚¢APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
    }
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ— & Hit-test
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let prevTime = null;

  renderer.setAnimationLoop((time, frame) => {
    // dtè¨ˆç®—
    let dt = 0;
    if (prevTime !== null) {
      dt = (time - prevTime) / 1000;
    }
    prevTime = time;

    const session = renderer.xr.getSession();

    // Hit-test ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    if (session && frame) {
      if (!hitTestSourceRequested) {
        session.requestReferenceSpace('viewer').then((viewerRefSpace) => {
          session.requestHitTestSource({ space: viewerRefSpace }).then((source) => {
            hitTestSource = source;
          });
        });
        hitTestSourceRequested = true;
      }

      if (hitTestSource) {
        const refSpace = renderer.xr.getReferenceSpace();
        const hits = frame.getHitTestResults(hitTestSource);
        if (hits.length > 0 && train && !trainPlaced) {
          const hit = hits[0];
          const pose = hit.getPose(refSpace);
          if (pose) {
            train.visible = true;
            train.position.set(
              pose.transform.position.x,
              pose.transform.position.y,
              pose.transform.position.z
            );
            // å‘ãã‚‚åºŠæ³•ç·šã«åˆã‚ã›ã‚‹ãŒã€Yå›è»¢ã¯ãã®ã¾ã¾ã«ã—ã¦ãŠãã“ã¨ã‚‚å¤šã„
            const q = pose.transform.orientation;
            train.quaternion.set(q.x, q.y, q.z, q.w);

            trainPlaced = true;
            showMessage('åˆ—è»Šã‚’åºŠã«é…ç½®ã—ã¾ã—ãŸã€‚ãƒœã‚¿ãƒ³ã§æ“ä½œã§ãã¾ã™ã€‚', 2500);
          }
        }
      }
    }

    // åˆ—è»Šç§»å‹•ï¼ˆãƒœã‚¿ãƒ³æŠ¼ã—ã£ã±ãªã—ä¸­ï¼‰
    if (train && trainPlaced && dt > 0) {
      const dir = moving.forward ? 1 : (moving.backward ? -1 : 0);
      const turn = moving.left ? 1 : (moving.right ? -1 : 0);

      if (dir !== 0 || turn !== 0) {
        const v = dir * MOVE_SPEED * dt; // å‰å¾Œã®ç§»å‹•é‡
        const forward = getForwardWorld(train);

        if (dir !== 0 && turn !== 0) {
          // ã‚«ãƒ¼ãƒ–èµ°è¡Œ
          const omega = (turn * v) / curveRadius; // rad
          train.rotation.y += omega;
          train.position.addScaledVector(forward, v);
        } else if (dir !== 0) {
          // ç›´é€²ã®ã¿
          train.position.addScaledVector(forward, v);
        } else if (turn !== 0) {
          // ãã®å ´ã§æ—‹å›
          const rotRad = THREE.MathUtils.degToRad(ROTATE_SPEED_DEG * dt * turn);
          train.rotation.y += rotRad;
        }
      }
    }

    renderer.render(scene, camera);
  });
</script>

</body>
</html>
