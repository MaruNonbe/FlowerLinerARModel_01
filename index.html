<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AR Train WebAR</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* ARéƒ¨åˆ†ã‚’å¸¸ã«ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«ã™ã‚‹ */
    a-scene {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 1;
    }

    /* UIãƒœã‚¿ãƒ³ */
    #ui {
      position: fixed;
      bottom: 10px;
      left: 0;
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
      z-index: 10;
      pointer-events: auto;
    }
    .btn {
      min-width: 60px;
      text-align: center;
      font-size: 14px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>

<body>
  <!-- ARã‚·ãƒ¼ãƒ³ï¼šHiroãƒãƒ¼ã‚«ãƒ¼ï¼‹ã‚«ãƒ¡ãƒ© -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;">

    <!-- ãƒãƒ¼ã‚«ãƒ¼ã«è¿½å¾“ã™ã‚‹ã‚«ãƒ¡ãƒ© -->
    <a-marker-camera preset="hiro">
      <!-- åˆ—è»Šï¼šã‚«ãƒ¡ãƒ©ã‹ã‚‰ç´„2må‰æ–¹ãƒ»å°‘ã—æŒã¡ä¸Šã’ã‚‹ -->
      <a-entity id="train"
                gltf-model="models/AR-Train_Nagai.glb"
                position="0 0.3 -2"
                rotation="0 0 0"
                scale="0.5 0.5 0.5">
      </a-entity>
    </a-marker-camera>
  </a-scene>

  <!-- UIãƒœã‚¿ãƒ³ç¾¤ -->
  <div id="ui">
    <div class="btn" id="btn-forward">â†‘</div>
    <div class="btn" id="btn-backward">â†“</div>
    <div class="btn" id="btn-left">â†</div>
    <div class="btn" id="btn-right">â†’</div>
    <div class="btn" id="btn-curve-right">â†’å³ã‚«ãƒ¼ãƒ–</div>
    <div class="btn" id="btn-curve-left">â†å·¦ã‚«ãƒ¼ãƒ–</div>

    <div class="btn" id="btn-up">â¬†ï¸</div>
    <div class="btn" id="btn-down">â¬‡ï¸</div>

    <div class="btn" id="btn-face">é¡”å†™çœŸè¨­å®š</div>
    <div class="btn" id="btn-face-rotate-y">é¡”YğŸ”„</div>
    <div class="btn" id="btn-face-rotate-x">é¡”XğŸ”„</div>
    <div class="btn" id="btn-face-x-plus">é¡”Xï¼‹</div>
    <div class="btn" id="btn-face-x-minus">é¡”Xï¼</div>
    <div class="btn" id="btn-face-y-plus">é¡”Yï¼‹</div>
    <div class="btn" id="btn-face-y-minus">é¡”Yï¼</div>

    <div class="btn" id="btn-zoom-in">ï¼‹</div>
    <div class="btn" id="btn-zoom-out">ï¼</div>

    <div class="btn" id="btn-capture">ğŸ“¸</div>
    <div class="btn" id="btn-record">ğŸ¥</div>
    <div class="btn" id="btn-share">ğŸ“¤</div>
  </div>

  <script>
    const train = document.querySelector('#train');
    let facePlate = null;                  // GLBå†…ã® a_Plate
    let forwardAxis = 'z';
    const FORWARD_SIGN = 1;

    let moving = {
      forward: false,
      backward: false,
      left: false,
      right: false,
      curveLeft: false,
      curveRight: false
    };

    let zoomLevel = 0.5;
    let recording = false, recorder, chunks = [];
    let faceRotationY = 0;
    let faceRotationX = 0;

    const MOVE_SPEED = 0.15;      // ç§»å‹•é€Ÿåº¦
    const ROTATE_SPEED = 1.0;     // ãã®å ´æ—‹å›è§’åº¦(åº¦)
    const CURVE_RADIUS = 2.0;     // ã‚«ãƒ¼ãƒ–åŠå¾„[m]

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿æ™‚ï¼ša_Plateå–å¾—ï¼‹é•·æ‰‹æ–¹å‘æ¨å®š
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    train.addEventListener('model-loaded', () => {
      const root = train.getObject3D('mesh');
      if (!root) return;

      // é‹è»¢å¸­ç”¨ãƒ—ãƒ¬ãƒ¼ãƒˆ
      facePlate = root.getObjectByName('a_Plate') ||
                  root.getObjectByProperty('name', 'a_Plate');

      // é•·æ‰‹æ–¹å‘åˆ¤å®š
      const box = new THREE.Box3().setFromObject(root);
      const sz = new THREE.Vector3();
      box.getSize(sz);
      forwardAxis = (sz.x > sz.z) ? 'x' : 'z';
    });

    // ãƒ­ãƒ¼ã‚«ãƒ«å‰æ–¹ãƒ™ã‚¯ãƒˆãƒ«ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›
    function getForwardWorld(obj3d) {
      const local = (forwardAxis === 'x')
        ? new THREE.Vector3(FORWARD_SIGN, 0, 0)
        : new THREE.Vector3(0, 0, FORWARD_SIGN);
      return local.applyQuaternion(obj3d.quaternion).normalize();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // åˆ—è»Šã®ç§»å‹•å‡¦ç†
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function moveTrain() {
      const obj = train.object3D;
      const pos = obj.position;

      // åŸºæœ¬ã¯ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‹ã‚‰æ±ºå®š
      let dir = moving.forward ? 1 : (moving.backward ? -1 : 0);
      let turn = moving.left ? 1 : (moving.right ? -1 : 0);

      // ã‚«ãƒ¼ãƒ–å°‚ç”¨ãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«å‰é€²ï¼‹æ—‹å›ï¼‰
      if (moving.curveLeft)  { dir = 1; turn = 1; }
      if (moving.curveRight) { dir = 1; turn = -1; }

      if (dir === 0 && turn === 0) return;

      const v = dir * MOVE_SPEED;
      const forward = getForwardWorld(obj);

      if (dir !== 0 && turn !== 0) {
        // ã‚«ãƒ¼ãƒ–èµ°è¡Œ
        const omega = (turn * v) / CURVE_RADIUS;
        obj.rotation.y += omega;
        pos.addScaledVector(forward, v);
      } else if (dir !== 0) {
        // ç›´é€²ï¼å¾Œé€€
        pos.addScaledVector(forward, v);
      } else if (turn !== 0) {
        // ãã®å ´æ—‹å›
        obj.rotation.y += turn * ROTATE_SPEED * Math.PI / 180;
      }

      if (Object.values(moving).some(v => v)) {
        requestAnimationFrame(moveTrain);
      }
    }

    // ãƒœã‚¿ãƒ³é•·æŠ¼ã—ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function setupButton(id, key) {
      const btn = document.getElementById(id);
      const start = (e) => {
        moving[key] = true;
        moveTrain();
        e.preventDefault();
      };
      const end = (e) => {
        moving[key] = false;
        e && e.preventDefault();
      };
      btn.addEventListener('mousedown', start);
      btn.addEventListener('touchstart', start, { passive: false });
      btn.addEventListener('mouseup', end);
      btn.addEventListener('mouseleave', end);
      btn.addEventListener('touchend', end);
      btn.addEventListener('touchcancel', end);
    }

    ['forward','backward','left','right'].forEach(id => setupButton(`btn-${id}`, id));
    setupButton('btn-curve-left',  'curveLeft');
    setupButton('btn-curve-right', 'curveRight');

    // ä¸Šä¸‹ç§»å‹•
    document.getElementById('btn-up').onclick   = () => train.object3D.position.y += 0.1;
    document.getElementById('btn-down').onclick = () => train.object3D.position.y -= 0.1;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // é¡”å†™çœŸã®è¨­å®š
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-face').onclick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'user';               // iOSã§ã‚«ãƒ¡ãƒ© or ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);

        const loader = new THREE.TextureLoader();
        loader.load(url, (tex) => {
          tex.flipY = false;
          tex.encoding = THREE.sRGBEncoding;
          tex.needsUpdate = true;

          if (facePlate) {
            // GLBå†…ã® a_Plate ã«ãã®ã¾ã¾è²¼ã‚‹ã®ã§ã€åˆ—è»Šã¨å®Œå…¨åŒæœŸ
            if (!Array.isArray(facePlate.material)) {
              facePlate.material.map = tex;
              facePlate.material.transparent = true;
              facePlate.material.needsUpdate = true;
            }
            facePlate.rotation.y = faceRotationY;
            facePlate.rotation.x = faceRotationX;
          } else {
            // a_Plate ãŒç„¡ã„å ´åˆï¼šåˆ—è»Šã®å­ã¨ã—ã¦Planeè¿½åŠ ï¼ˆé‹è»¢å¸­ä»˜è¿‘ã«ä»®é…ç½®ï¼‰
            const geo = new THREE.PlaneGeometry(0.6, 0.6);
            const mat = new THREE.MeshBasicMaterial({
              map: tex,
              transparent: true,
              side: THREE.DoubleSide,
              depthTest: false,
              depthWrite: false
            });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(0, 1.4, 2.0);   // è»Šä½“å…ˆé ­ã‚ãŸã‚Šï¼ˆå¿…è¦ã«å¿œã˜ã¦å¾®èª¿æ•´ï¼‰
            mesh.rotation.y = faceRotationY;
            mesh.rotation.x = faceRotationX;
            mesh.renderOrder = 10;
            train.object3D.add(mesh);
            facePlate = mesh;
          }
        });
      };
      input.click();
    };

    document.getElementById('btn-face-rotate-y').onclick = () => {
      if (facePlate) {
        faceRotationY += Math.PI / 2;
        facePlate.rotation.y = faceRotationY;
      }
    };
    document.getElementById('btn-face-rotate-x').onclick = () => {
      if (facePlate) {
        faceRotationX += Math.PI / 2;
        facePlate.rotation.x = faceRotationX;
      }
    };

    document.getElementById('btn-face-x-plus').onclick  = () => { if (facePlate) facePlate.position.x += 0.05; };
    document.getElementById('btn-face-x-minus').onclick = () => { if (facePlate) facePlate.position.x -= 0.05; };
    document.getElementById('btn-face-y-plus').onclick  = () => { if (facePlate) facePlate.position.y += 0.05; };
    document.getElementById('btn-face-y-minus').onclick = () => { if (facePlate) facePlate.position.y -= 0.05; };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ã‚ºãƒ¼ãƒ ï¼ˆåˆ—è»Šã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-zoom-in').onclick = () => {
      zoomLevel += 0.1;
      train.object3D.scale.set(zoomLevel, zoomLevel, zoomLevel);
    };
    document.getElementById('btn-zoom-out').onclick = () => {
      zoomLevel = Math.max(0.1, zoomLevel - 0.1);
      train.object3D.scale.set(zoomLevel, zoomLevel, zoomLevel);
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // å†™çœŸæ’®å½±ãƒ»éŒ²ç”»ãƒ»å…±æœ‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-capture').onclick = () => {
      const canvas = document.querySelector('canvas');
      if (!canvas) return;
      canvas.toBlob(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'snapshot.png';
        a.click();
      });
    };

    document.getElementById('btn-record').onclick = () => {
      const canvas = document.querySelector('canvas');
      if (!canvas) return;

      if (!recording) {
        const stream = canvas.captureStream();
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = (e) => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'recording.webm';
          a.click();
          chunks = [];
        };
        recorder.start();
        recording = true;
        alert('éŒ²ç”»é–‹å§‹');
      } else {
        recorder.stop();
        recording = false;
        alert('éŒ²ç”»çµ‚äº†');
      }
    };

    document.getElementById('btn-share').onclick = () => {
      if (navigator.share) {
        navigator.share({
          title: 'AR Train',
          text: 'ARã§é‹è»¢å£«ä½“é¨“ã‚’ã—ã¦ã¿ã¾ã—ãŸï¼',
          url: location.href
        }).catch(() => {});
      } else {
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Webã‚·ã‚§ã‚¢APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
      }
    };
  </script>
</body>
</html>
