<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AR Train Control Fixed</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    /* åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ */
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; background: transparent; font-family: sans-serif;
      /* ã‚¹ãƒãƒ›ã§ã®é•·æŠ¼ã—é¸æŠãªã©ã‚’ç„¡åŠ¹åŒ– */
      user-select: none; -webkit-touch-callout: none;
    }
    a-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

    /* UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
    #ui-container {
      position: fixed; bottom: 20px; left: 0; width: 100%;
      z-index: 9999;
      display: flex; flex-direction: column; align-items: center;
      gap: 15px;
      pointer-events: none; /* UIã®éš™é–“ã¯ã‚¿ãƒƒãƒã‚’é€éã•ã›ã‚‹ */
    }

    /* å„ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒãƒ¼ */
    .ui-bar {
      display: flex; gap: 10px;
      pointer-events: auto; /* ãƒœã‚¿ãƒ³éƒ¨åˆ†ã¯ã‚¿ãƒƒãƒæœ‰åŠ¹ */
      background: rgba(255,255,255,0.2);
      padding: 8px; border-radius: 12px;
      backdrop-filter: blur(2px);
    }

    /* 3x3 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚°ãƒªãƒƒãƒ‰ */
    .pad-grid {
      display: grid;
      grid-template-columns: repeat(3, 64px);
      grid-template-rows: repeat(3, 64px);
      gap: 8px;
      background: rgba(255, 255, 255, 0.4);
      padding: 10px; border-radius: 16px;
      pointer-events: auto;
    }

    /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .btn {
      width: 64px; height: 48px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ccc; border-radius: 8px;
      display: flex; justify-content: center; align-items: center;
      font-size: 20px; font-weight: bold; color: #333;
      box-shadow: 0 3px 0 #999;
      cursor: pointer; transition: all 0.1s;
    }
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨ã®æ­£æ–¹å½¢ãƒœã‚¿ãƒ³ */
    .pad-grid .btn { width: 64px; height: 64px; font-size: 28px; }

    /* ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®è¦‹ãŸç›® */
    .btn:active { transform: translateY(3px); box-shadow: 0 0 0 #999; background: #eee; }
    
    /* STOPãƒœã‚¿ãƒ³ */
    .btn-stop { background: #ffcccc; color: #d00; font-size: 16px; }
    /* ã‚¢ã‚¤ã‚³ãƒ³ä»˜ããƒœã‚¿ãƒ³ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
    .btn-icon { font-size: 14px; flex-direction: column; gap: 2px; }
    .btn-icon span { font-size: 20px; }
  </style>
</head>
<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  renderer="precision: mediump; antialias: true; alpha: true; logarithmicDepthBuffer: true;"
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
>
  <a-marker-camera preset="hiro">
    <a-entity id="train"
              gltf-model="models/AR-Train_Nagai.glb"
              position="0 0 0"
              scale="0.5 0.5 0.5">
    </a-entity>
  </a-marker-camera>
</a-scene>

<div id="ui-container">
  
  <div class="ui-bar">
    <div class="btn btn-icon" id="btn-face"><span>ğŸ™‚</span>é¡”</div>
    <div class="btn btn-icon" id="btn-up"><span>â¬†</span>é«˜</div>
    <div class="btn btn-icon" id="btn-down"><span>â¬‡</span>ä½</div>
    <div class="btn btn-icon" id="btn-zoom-in"><span>ğŸ”</span>+</div>
    <div class="btn btn-icon" id="btn-zoom-out"><span>ğŸ”</span>-</div>
  </div>
  
  <div class="ui-bar">
    <div class="btn btn-icon" id="btn-capture"><span>ğŸ“·</span>æ’®</div>
    <div class="btn btn-icon" id="btn-record"><span>ğŸ¥</span>éŒ²</div>
  </div>

  <div class="pad-grid">
    <div class="btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn" id="btn-fwd">â†‘</div>
    <div class="btn" id="btn-curve-right-fwd">â†—</div>

    <div class="btn" id="btn-turn-left">â†º</div>
    <div class="btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn" id="btn-turn-right">â†»</div>

    <div class="btn" id="btn-curve-left-back">â†™</div>
    <div class="btn" id="btn-back">â†“</div>
    <div class="btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
/* ========== åˆæœŸè¨­å®š ========== */
const train = document.querySelector('#train');

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
let speed = 0.04;       // å‰é€²é€Ÿåº¦ï¼ˆå°‘ã—ã‚†ã£ãã‚Šã«è¨­å®šï¼‰
let turnSpeed = 2.5;    // ãã®å ´å›è»¢ã®é€Ÿåº¦
let curveRadius = 0.5;  // ã‚«ãƒ¼ãƒ–ã®åŠå¾„ï¼ˆå°ã•ã„ã»ã©æ€¥ã‚«ãƒ¼ãƒ–ï¼‰

// æ“ä½œçŠ¶æ…‹ç®¡ç†ãƒ•ãƒ©ã‚°
let state = {
  moving: 0,   // 0:åœæ­¢, 1:å‰é€², -1:å¾Œé€²
  turning: 0   // 0:ãªã—, 1:å·¦æ—‹å›, -1:å³æ—‹å›
};

/* ========== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ï¼‰ ========== */
function loop() {
  requestAnimationFrame(loop);
  
  if (!train.object3D) return;
  const mesh = train.object3D;

  // --- 1. å›è»¢å‡¦ç† ---
  if (state.turning !== 0) {
    let rotationAmount = 0;
    
    if (state.moving !== 0) {
      // ã€ã‚«ãƒ¼ãƒ–èµ°è¡Œã€‘ç§»å‹•ã—ãªãŒã‚‰ã®æ—‹å›
      // è§’é€Ÿåº¦ Ï‰ = v / r ã‚’è¨ˆç®—
      const omega = (speed / curveRadius);
      rotationAmount = omega * state.turning;
      
      // å¾Œé€²æ™‚ã¯ã€è»Šã®ãƒãƒ³ãƒ‰ãƒ«ã®ã‚ˆã†ã«é€†å‘ãã«å›è»¢ã•ã›ã‚‹
      if (state.moving === -1) rotationAmount *= -1;
      
    } else {
      // ã€ãã®å ´å›è»¢ã€‘ï¼ˆä¿¡åœ°æ—‹å›ï¼‰
      rotationAmount = THREE.MathUtils.degToRad(turnSpeed) * state.turning;
    }
    // Yè»¸å›è»¢ã‚’é©ç”¨
    mesh.rotation.y += rotationAmount;
  }

  // --- 2. ç§»å‹•å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
  if (state.moving !== 0) {
    // â˜…ã“ã“ã‚’ä¿®æ­£ï¼štranslateZ ã‚’ä½¿ç”¨ã—ã¦ã€Œç¾åœ¨ã®æ­£é¢ã€ã«é€²ã‚€ã‚ˆã†ã«å¤‰æ›´
    // å¤šãã®ãƒ¢ãƒ‡ãƒ«ã¯ã€ŒZãƒã‚¤ãƒŠã‚¹æ–¹å‘ã€ãŒå‰æ–¹ãªã®ã§ã€è² ã®å€¤ã‚’æ¸¡ã—ã¦å‰é€²ã•ã›ã¾ã™ã€‚
    const moveDistance = -state.moving * speed;
    mesh.translateZ(moveDistance);
  }
}
// ãƒ«ãƒ¼ãƒ—é–‹å§‹
loop();

/* ========== ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆã‚¹ãƒãƒ›å¯¾å¿œå¼·åŒ–ï¼‰ ========== */
function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  if(!btn) return;

  // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸï¼ˆã‚¿ãƒƒãƒé–‹å§‹ï¼‰
  const start = (e) => {
    if (e.cancelable) e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç­‰ã‚’é˜²ã
    state.moving = moveVal;
    state.turning = turnVal;
  };
  
  // ãƒœã‚¿ãƒ³ã‚’é›¢ã—ãŸï¼ˆã‚¿ãƒƒãƒçµ‚äº†ï¼‰
  const end = (e) => {
    if (e.cancelable) e.preventDefault();
    // é›¢ã—ãŸã‚‰åœæ­¢ã•ã›ã‚‹ï¼ˆæŠ¼ã—ã£ã±ãªã—ã§é€²ã‚€æ“ä½œæ„Ÿï¼‰
    state.moving = 0;
    state.turning = 0;
  };

  // ã‚¹ãƒãƒ›ã¨PCä¸¡æ–¹ã®ã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾å¿œ
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('mouseup', end);
  btn.addEventListener('mouseleave', end);
}

// --- ãƒœã‚¿ãƒ³å‰²ã‚Šå½“ã¦å®Ÿè¡Œ ---
// ç›´é€²ãƒ»å¾Œé€²
setAction('btn-fwd',  1, 0);
setAction('btn-back', -1, 0);
// ãã®å ´å›è»¢
setAction('btn-turn-left',  0, 1);
setAction('btn-turn-right', 0, -1);
// â˜…ã‚«ãƒ¼ãƒ–èµ°è¡Œï¼ˆæ–œã‚ï¼‰
setAction('btn-curve-left-fwd', 1, 1);   // å·¦å‰
setAction('btn-curve-right-fwd', 1, -1); // å³å‰
setAction('btn-curve-left-back', -1, 1); // å·¦å¾Œ
setAction('btn-curve-right-back', -1, -1);// å³å¾Œ

// STOPãƒœã‚¿ãƒ³
document.getElementById('btn-stop').addEventListener('click', (e) => {
  e.preventDefault();
  state.moving = 0; state.turning = 0;
});


/* ========== é¡”å†™çœŸæ©Ÿèƒ½ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰ ========== */
document.getElementById('btn-face').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    // æ—¢å­˜ã®é¡”å†™çœŸãŒã‚ã‚Œã°å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    const oldFace = train.object3D.getObjectByName('custom_face');
    if(oldFace) train.object3D.remove(oldFace);

    const url = URL.createObjectURL(file);
    new THREE.TextureLoader().load(url, (tex) => {
      tex.encoding = THREE.sRGBEncoding;
      
      // â˜…ä¿®æ­£1ï¼šä¸Šä¸‹é€†å•é¡Œã‚’è§£æ¶ˆï¼ˆflipYã‚’trueã«å¤‰æ›´ï¼‰
      tex.flipY = true; 
      
      const geo = new THREE.PlaneGeometry(0.8, 0.8); // ã‚µã‚¤ã‚ºã¯ãŠå¥½ã¿ã§
      const mat = new THREE.MeshBasicMaterial({
        map: tex,
        side: THREE.DoubleSide,
        transparent: true,
        depthTest: true // å‰å¾Œé–¢ä¿‚ã‚’æ­£ã—ãæç”»
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.name = 'custom_face'; // åå‰ã‚’ä»˜ã‘ã¦ç®¡ç†ã—ã‚„ã™ãã™ã‚‹

      // â˜…ä¿®æ­£2ï¼šä½ç½®ã®èª¿æ•´ï¼ˆæµ®ã‹ãªã„ã‚ˆã†ã«å¥¥ã¸ã€é«˜ã•ã‚‚èª¿æ•´ï¼‰
      // ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ã‚±ãƒ¼ãƒ«ãŒ0.5ãªã®ã§ã€å€¤ã¯å°ã•ã‚ã«ãªã‚Šã¾ã™ã€‚
      // Z=0.48ã‚ãŸã‚ŠãŒè»Šä½“è¡¨é¢ã‚®ãƒªã‚®ãƒªã¨æ¨æ¸¬ã€‚Y=1.7ã§å°‘ã—ä¸‹ã¸ã€‚
      mesh.position.set(0, 1.7, 0.48); 

      train.object3D.add(mesh);
    });
  };
  input.click();
};

/* ========== ãã®ä»–ã®ä¾¿åˆ©æ©Ÿèƒ½ ========== */
// é«˜ã•èª¿æ•´
document.getElementById('btn-up').onclick = () => train.object3D.position.y += 0.1;
document.getElementById('btn-down').onclick = () => train.object3D.position.y -= 0.1;

// ã‚ºãƒ¼ãƒ 
let currentScale = 0.5;
const updateScale = () => train.object3D.scale.set(currentScale,currentScale,currentScale);
document.getElementById('btn-zoom-in').onclick = () => { currentScale += 0.1; updateScale(); };
document.getElementById('btn-zoom-out').onclick = () => { currentScale = Math.max(0.1, currentScale - 0.1); updateScale(); };

// æ’®å½±ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
document.getElementById('btn-capture').onclick = () => {
  const canvas = document.querySelector('canvas');
  canvas.toBlob(blob => {
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'ar_snapshot.png'; a.click();
  });
};

// ç”»é¢ãƒªã‚µã‚¤ã‚ºæ™‚ã®æ­ªã¿è£œæ­£
window.addEventListener('resize', () => {
  const scene = document.querySelector('a-scene');
  if(scene.camera) {
    scene.camera.aspect = window.innerWidth / window.innerHeight;
    scene.camera.updateProjectionMatrix();
  }
});
</script>
</body>
</html>